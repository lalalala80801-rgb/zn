
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
<title>æ™ºèƒ½äº¤æ˜“æ‰€ Â· äº‘åŒæ­¥ï¼ˆv2.9 ç§»åŠ¨å‹å¥½ç‰ˆï¼‰</title>
<style>
:root{--bg:#0a0f1a;--panel:#0f172a;--panel2:#0b1324;--text:#e5e7eb;--muted:#9fb3c8;--buy:#ef4444;--sell:#3b82f6;--grid:#1f2a3d}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,#0b1b30 10%,#0a0f1a 60%);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif}
.wrap{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
header{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:10px 12px}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{background:#111827;border:1px solid #2b3648;border-radius:10px;color:#e5e7eb;padding:6px 10px;font-weight:600;cursor:pointer}
.board{background:linear-gradient(180deg,#0f172a,#0b1324);border:1px solid #233146;border-radius:14px;margin:10px 12px;box-shadow:0 10px 28px rgba(0,0,0,.35);overflow:hidden}
.thead,.row{display:grid;grid-template-columns:88px 1fr 220px 190px 190px;align-items:center}
.thead{background:#0e1527;border-bottom:1px solid #233146}
.cell{padding:10px 8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:22px}
.tb{max-height:72vh;overflow:hidden;position:relative}
.page-indicator{position:absolute;left:50%;bottom:10px;transform:translateX(-50%);background:rgba(0,0,0,.25);border:1px solid #223049;border-radius:999px;padding:6px 10px;font-weight:800}
.num{min-width:8ch;text-align:center;padding:6px 8px;border-radius:8px}
.buy{color:var(--buy);font-weight:900}.sell{color:var(--sell);font-weight:900}.denom{font-weight:900;min-width:7ch;text-align:center}
footer{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;padding:10px 12px;border-top:1px solid #233146;color:var(--muted)}
#loginFloat{position:fixed;right:16px;bottom:22px;z-index:1000;background:#0b1222d9;border:1px solid #2b3648;color:#e5e7eb;border-radius:999px;height:44px;padding:0 14px;display:none;gap:8px;justify-content:center;align-items:center;font-weight:700;box-shadow:0 8px 20px rgba(0,0,0,.35)}
#loginDlg{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1200}
#loginPanel{background:#0b1222;border:1px solid #2b3648;border-radius:14px;width:min(420px,92vw);padding:16px}
#loginPanel h3{margin:0 0 10px 0}.form-row{display:flex;gap:8px;align-items:center;margin:8px 0}.form-row label{width:80px;color:#9fb3c8}.form-row input{flex:1;background:#0b1222;color:#e5e7eb;border:1px solid #2b3648;border-radius:8px;padding:10px}.form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

/* ====== ç§»åŠ¨ç´§å‡‘å¡ç‰‡è§†å›¾ï¼ˆportraitï¼‰ ====== */
#mobileCards{display:none;padding:10px 12px}
.card{background:linear-gradient(180deg,#0f172a,#0b1324);border:1px solid #233146;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.35);padding:12px 12px;margin-bottom:12px}
.ch{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.flag{font-size:24px}.code{font-weight:800}.name{opacity:.9}
.table3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.cell3{background:#0b1326;border:1px solid #24324a;border-radius:10px;padding:10px 8px;text-align:center}
.denom3{font-weight:800}.buy3{color:var(--buy);font-weight:900;font-size:18px}.sell3{color:var(--sell);font-weight:900;font-size:18px}
.mpi{position:sticky;bottom:6px;left:0;right:0;margin-top:8px;text-align:center;color:#9fb3c8}
/* portrait è‡ªåŠ¨åˆ‡æ¢åˆ°å¡ç‰‡æ¨¡å¼ */
@media (max-width: 480px) and (orientation: portrait){
  #desktopTable{display:none}
  #mobileCards{display:block}
}
</style>
</head>
<body>
<button id="loginFloat">ğŸ” ç™»å½•</button>

<div class="wrap">
  <header>
    <div style="font-weight:900;font-size:20px">æ™ºèƒ½äº¤æ˜“æ‰€ Â· æ›¼è°·</div>
    <div class="controls" id="controls" style="display:none">
      <button class="btn" id="btn-cycle">â–¶ï¸ è½®æ’­æ’­æ”¾</button>
      <label class="btn">é€Ÿåº¦
        <input id="speed" type="range" min="0" max="60" step="1" value="6" style="width:120px">
        <input id="speedNum" type="number" min="0" max="120" step="1" value="6" style="width:54px;background:#0b1222;color:#e5e7eb;border:1px solid #2b3648;border-radius:8px;padding:6px">
        <span id="speedLabel">ç§’</span>
      </label>
      <label class="btn">æ¯é¡µå›½å®¶ <input id="rppNum" type="number" min="2" max="8" step="1" value="3" style="width:46px;background:#0b1222;color:#e5e7eb;border:1px solid #2b3648;border-radius:8px;padding:6px"></label>
      <button class="btn" id="btn-lock">ğŸ”’ å·²é”å®š</button>
      <button class="btn" id="btn-logout">é€€å‡º</button>
      <span class="small" id="loginState"></span>
      <span class="small" id="cloudState">â˜ï¸ äº‘åŒæ­¥ï¼šå¼€</span>
    </div>
    <div style="text-align:right">
      <div id="time" style="font-weight:800">--:--:--</div>
      <div id="date" style="font-size:12px;opacity:.8">â€”</div>
    </div>
  </header>

  <section id="desktopTable" class="board">
    <div class="thead">
      <div class="cell"></div>
      <div class="cell">Currency è´§å¸ Â· à¸ªà¸à¸¸à¸¥à¹€à¸‡à¸´à¸™</div>
      <div class="cell" style="text-align:center">Denomination é¢é¢</div>
      <div class="cell" style="text-align:center;color:#ef4444;font-weight:900">BUY ä¹°å…¥</div>
      <div class="cell" style="text-align:center;color:#3b82f6;font-weight:900">SELL å–å‡º</div>
    </div>
    <div class="tb">
      <div id="page"></div>
      <div class="page-indicator" id="pageIndicator">ç¬¬ 1 / 1 é¡µ</div>
    </div>
  </section>

  <!-- ç§»åŠ¨ç´§å‡‘å¡ç‰‡ -->
  <section id="mobileCards"></section>

  <footer>
    <div>å¿«æ·é”®ï¼šF å…¨å± Â· Space æ’­æ”¾/æš‚åœ Â· â†/â†’ æ¢é¡µ</div>
    <div>ä¸Šæ¬¡ä¿®æ”¹ï¼š<span id="updated">â€”</span></div>
    <div style="text-align:right">æ±‡ç‡ä»…ä¾›å‚è€ƒï¼Œæˆäº¤ä»¥æŸœå°æŠ¥ä»·ä¸ºå‡†ã€‚</div>
  </footer>
</div>

<!-- ç™»å½•å¼¹çª— -->
<div id="loginDlg">
  <div id="loginPanel">
    <h3>å‘˜å·¥ç™»å½•</h3>
    <form id="loginForm" autocomplete="off">
      <div class="form-row"><label for="acc">è´¦å·</label><input id="acc" name="acc_x" type="text" inputmode="latin" autocomplete="off" placeholder="ä¾‹å¦‚ znjys"></div>
      <div class="form-row"><label for="pwd">å¯†ç </label><input id="pwd" name="pwd_x" type="password" autocomplete="new-password" placeholder="ä¾‹å¦‚ 5201314"></div>
      <div class="form-actions">
        <button type="button" class="btn" id="btnCancel">å–æ¶ˆ</button>
        <button type="submit" class="btn">ç™»å½•</button>
      </div>
    </form>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script>
window.FB_CONFIG = {"apiKey": "AIzaSyD0dEK5P8CHdHPUBFCNLQRBlSRuCtv3GIs", "authDomain": "znjys-b4c98.firebaseapp.com", "databaseURL": "https://znjys-b4c98-default-rtdb.asia-southeast1.firebasedatabase.app", "projectId": "znjys-b4c98", "storageBucket": "znjys-b4c98.firebasestorage.app", "messagingSenderId": "762313114991", "appId": "1:762313114991:web:092c17431572a281f0549a", "measurementId": "G-W835L9T6DG"};
const ROOM='bangkok';
// ç®¡ç†å…¥å£ï¼šåªæœ‰ ?admin=1 æ‰æ˜¾ç¤ºç™»å½•æŒ‰é’®
if (new URLSearchParams(location.search).get('admin')==='1') document.getElementById('loginFloat').style.display='flex';

let app=null, db=null, ref=null, auth=null;
let CAN_WRITE=false, cloudOn=false;
let locked=true, isPaused=false, applying=false;
let pages=[], currentPage=0, cycleTimer=null;
const STORE_KEY='exchange-cloud-v1-data-store';
const S=(n)=> (+n).toFixed(2);
const sanitize=(s)=>{const n=parseFloat(String(s).replace(/[^0-9.\-]/g,'')); return isNaN(n)?null:Math.max(0,n);};

// æ•°æ®
let DATA=[
  {flag:'ğŸ‡ºğŸ‡¸',cn:'ç¾å…ƒ',en:'USD',items:[{denom:'$1',buy:32.10,sell:32.60},{denom:'$5â€“20',buy:32.40,sell:32.70},{denom:'$100',buy:32.70,sell:32.73}]},
  {flag:'ğŸ‡ªğŸ‡º',cn:'æ¬§å…ƒ',en:'EUR',items:[{denom:'â‚¬5â€“20',buy:37.60,sell:37.95},{denom:'â‚¬50',buy:37.80,sell:38.00},{denom:'â‚¬100',buy:37.91,sell:38.05}]},
  {flag:'ğŸ‡¬ğŸ‡§',cn:'è‹±é•‘',en:'GBP',items:[{denom:'Â£5â€“20',buy:43.10,sell:43.50},{denom:'Â£50',buy:43.40,sell:43.60},{denom:'Â£100',buy:43.51,sell:43.65}]},
  {flag:'ğŸ‡¨ğŸ‡³',cn:'äººæ°‘å¸',en:'CNY',items:[{denom:'Â¥10â€“50',buy:4.55,sell:4.62},{denom:'Â¥100',buy:4.61,sell:4.65},{denom:'Â¥200+',buy:4.62,sell:4.66}]},
  {flag:'ğŸ‡¸ğŸ‡¬',cn:'æ–°å…ƒ',en:'SGD',items:[{denom:'$20â€“5',buy:27.00,sell:27.30},{denom:'$50â€“100',buy:27.30,sell:27.55},{denom:'$1000',buy:27.25,sell:27.40}]},
  {flag:'ğŸ‡¦ğŸ‡º',cn:'æ¾³å…ƒ',en:'AUD',items:[{denom:'$5â€“20',buy:20.90,sell:21.20},{denom:'$50â€“100',buy:21.13,sell:21.30},{denom:'$500+',buy:21.20,sell:21.35}]},
  {flag:'ğŸ‡­ğŸ‡°',cn:'æ¸¯å¸',en:'HKD',items:[{denom:'$20â€“50',buy:4.18,sell:4.21},{denom:'$100â€“500',buy:4.21,sell:4.22},{denom:'$1000',buy:4.215,sell:4.225}]},
  {flag:'ğŸ‡²ğŸ‡¾',cn:'é©¬å¸',en:'MYR',items:[{denom:'5â€“20',buy:7.60,sell:7.72},{denom:'50â€“100',buy:7.68,sell:7.76},{denom:'500+',buy:7.70,sell:7.78}]},
  {flag:'ğŸ‡°ğŸ‡·',cn:'éŸ©å…ƒ',en:'KRW',items:[{denom:'â‚©1kâ€“5k',buy:0.0235,sell:0.0245},{denom:'â‚©10k',buy:0.024,sell:0.025},{denom:'â‚©50k',buy:0.0242,sell:0.0252}]}
];

// ===== æ¸²æŸ“ï¼ˆæ¡Œé¢è¡¨æ ¼ï¼‰ =====
const pageEl=document.getElementById('page'); const pi=document.getElementById('pageIndicator');
function buildRows(){const list=[]; DATA.forEach((g,gi)=>g.items.forEach((it,si)=>list.push({gi,si,showHead:si===0}))); return list;}
function drawTable(p){
  const rows=buildRows(); const rpp=(Number(document.getElementById('rppNum').value)||3)*3;
  const pages=[]; for(let i=0;i<rows.length;i+=rpp) pages.push(rows.slice(i,i+rpp));
  if(p>=pages.length) p=pages.length-1; if(p<0) p=0; currentPage=p;
  const cur=pages[p]; pageEl.innerHTML=''; let lastGi=-1;
  cur.forEach((r)=>{
    const g=DATA[r.gi],it=g.items[r.si];
    if(r.gi!==lastGi){
      const head=document.createElement('div'); head.className='row'; head.dataset.gi=r.gi; head.dataset.si=-1;
      head.innerHTML=`<div class="cell">${g.flag}</div><div class="cell"><b>${g.cn}</b> <span style="opacity:.85">${g.en}</span></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>`;
      pageEl.appendChild(head); lastGi=r.gi;
    }
    const row=document.createElement('div'); row.className='row'; row.dataset.gi=r.gi; row.dataset.si=r.si;
    row.innerHTML=`
      <div class="cell"></div>
      <div class="cell"></div>
      <div class="cell"><div class="num denom">${it.denom}</div></div>
      <div class="cell"><div class="num buy">${S(it.buy)}</div></div>
      <div class="cell"><div class="num sell">${S(it.sell)}</div></div>`;
    pageEl.appendChild(row);
  });
  pi.textContent=`ç¬¬ ${p+1} / ${pages.length} é¡µ`;
  return pages.length;
}

// ===== æ¸²æŸ“ï¼ˆç§»åŠ¨å¡ç‰‡ï¼‰ =====
const mobile = document.getElementById('mobileCards');
function drawMobileCards(){
  mobile.innerHTML='';
  DATA.forEach(g=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`
      <div class="ch"><div class="flag">${g.flag}</div><div class="code">${g.en}</div><div class="name">${g.cn}</div></div>
      <div class="table3">
        ${g.items.map(it=>`
          <div class="cell3">
            <div class="denom3">${it.denom}</div>
            <div class="buy3">${S(it.buy)}</div>
            <div class="sell3">${S(it.sell)}</div>
          </div>
        `).join('')}
      </div>`;
    mobile.appendChild(card);
  });
  const tip=document.createElement('div'); tip.className='mpi'; tip.textContent='å‘ä¸‹æ»šåŠ¨æŸ¥çœ‹æ›´å¤šå›½å®¶'; mobile.appendChild(tip);
}

// ===== Controls =====
document.getElementById('rppNum').addEventListener('change',()=>drawTable(currentPage));
document.getElementById('btn-cycle').onclick=()=>{ isPaused=!isPaused; };
document.getElementById('speed').addEventListener('input',e=>{ document.getElementById('speedNum').value=e.target.value; });
document.getElementById('speedNum').addEventListener('change',e=>{ document.getElementById('speed').value=e.target.value; });

// ===== Cloud sync é»˜è®¤å¼€å¯ =====
function cloudEnable(on){
  if(on===cloudOn) return;
  if(on){
    try{
      app=firebase.apps?.length?firebase.app():firebase.initializeApp(FB_CONFIG);
      db=firebase.database();
      ref=db.ref('exchange/cloud/v1/'+ROOM);
      ref.on('value',snap=>{
        const v=snap.val(); if(!v) return;
        if(v.data) DATA=v.data;
        document.getElementById('updated').textContent=new Date(v.updated||Date.now()).toLocaleString();
        drawTable(currentPage); drawMobileCards();
      });
      cloudOn=true; document.getElementById('cloudState').textContent='â˜ï¸ äº‘åŒæ­¥ï¼šå¼€';
    }catch(e){ alert('è¿æ¥ Firebase å¤±è´¥'); }
  }else{
    if(ref) ref.off(); cloudOn=false; document.getElementById('cloudState').textContent='â˜ï¸ äº‘åŒæ­¥ï¼šå…³';
  }
}
function pushNow(){ if(!cloudOn || !ref || !CAN_WRITE) return; ref.set({ data: DATA, updated: Date.now() }); }

// ===== ç™»å½•ï¼ˆç¦ç”¨è‡ªåŠ¨å¡«å……ï¼‰ =====
const loginFloat=document.getElementById('loginFloat'); const loginDlg=document.getElementById('loginDlg');
document.getElementById('btnCancel').onclick=()=> loginDlg.style.display='none';
loginFloat.onclick=()=> loginDlg.style.display='flex';
document.getElementById('btn-logout').onclick=async()=>{ try{ await firebase.auth().signOut(); alert('å·²é€€å‡º'); location.reload(); }catch(e){} };
document.getElementById('loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  try{
    const acc=(document.getElementById('acc').value||'').trim()||'znjys';
    const pwd=document.getElementById('pwd').value;
    const email=acc+'@znjys.local';
    auth=firebase.auth();
    const r=await auth.signInWithEmailAndPassword(email,pwd);
    const uid=r.user.uid;
    const s=await firebase.database().ref('roles/'+uid+'/write').once('value');
    CAN_WRITE=(s.val()===true);
    if(!CAN_WRITE) alert('ç™»å½•æˆåŠŸï¼Œä½†æ²¡æœ‰å†™å…¥æƒé™');
    // æ˜¾ç¤ºæ§åˆ¶å°
    document.getElementById('controls').style.display='flex';
    loginFloat.style.display='none';
    loginDlg.style.display='none';
  }catch(err){ alert('ç™»å½•å¤±è´¥ï¼š'+(err?.message||'')); }
});

// ===== Init =====
(function init(){
  drawTable(0); drawMobileCards();
  cloudEnable(true);
  // ç®¡ç†å…¥å£æŒ‰é’®ï¼ˆ?admin=1ï¼‰
  if (new URLSearchParams(location.search).get('admin')==='1') document.getElementById('loginFloat').style.display='flex';
  (function tick(){ const n=new Date(); document.getElementById('time').textContent=n.toLocaleTimeString(); document.getElementById('date').textContent=n.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric',weekday:'long'}); setTimeout(tick,1000); })();
  // é”®ç›˜
  document.addEventListener('keydown',e=>{
    if(e.key===' '){ e.preventDefault(); isPaused=!isPaused; }
    if(e.key==='F'||e.key==='f'){ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
    if(e.key==='ArrowRight'){ currentPage++; drawTable(currentPage); }
    if(e.key==='ArrowLeft'){ currentPage--; drawTable(currentPage); }
  });
})();
</script>
</body>
</html>
