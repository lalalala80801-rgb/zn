<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>æ™ºèƒ½äº¤æ˜“æ‰€ Â· æ›¼è°· Â· äº‘åŒæ­¥ï¼ˆé—¨åº—ç»ˆæ v2.7ï¼‰</title>
<style>
:root{
  --bg:#0a0f1a; --panel:#0f172a; --panel2:#0b1324; --accent:#f59e0b;
  --buy:#ef4444; --sell:#3b82f6; --text:#e5e7eb; --muted:#9ca3af; --grid:#1f2a3d;
  --radius:18px; --shadow:0 12px 44px rgba(0,0,0,.45),0 0 0 1px rgba(20,184,166,.18) inset;
  --fs-base:1;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background: radial-gradient(1200px 800px at 10% -10%, #0b1b30 10%, #0a0f1a 60%);
  color:var(--text); font-family: Inter,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
  user-select:none;
}
[contenteditable]{-webkit-user-select:text; user-select:text; cursor:text;}
.wrap{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
header{display:grid;grid-template-columns:auto 1fr auto;gap:16px;align-items:center;padding:12px 14px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:48px;height:48px}
.shopname .cn{font-size:clamp(20px,2.1vw,28px);font-weight:900;letter-spacing:.5px}
.shopname .en{font-size:12px;opacity:.9}
.hours{color:#a7f3d0;font-weight:800}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{background:#111827;color:#e5e7eb;border:1px solid #2b3648;border-radius:10px;padding:7px 10px;font-weight:600;cursor:pointer}
.btn:hover{background:#0f172a}
.btn[aria-pressed="true"]{outline:2px solid #2563eb}
.small{font-size:12px;opacity:.85}
.clock{text-align:right}.clock .time{font-size:22px;font-weight:800}.clock .date{font-size:12px;color:#9fb3c8}
footer{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;padding:10px 14px;border-top:1px solid #233146;color:#9fb3c8}

.board{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #233146;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);margin:12px 14px}
.thead,.row{display:grid;grid-template-columns:88px 1fr 220px 190px 190px;align-items:center}
.thead{background:linear-gradient(180deg,#0e1527,#0b1120);border-bottom:1px solid #233146;position:sticky;top:0;z-index:2}
.thead div{padding:12px 8px;font-weight:900;letter-spacing:.4px}
.th-c,.th-b,.th-s,.th-d{font-size:24px}
.tb{max-height:72vh;overflow:hidden;position:relative}
.page{overflow-y:auto;overflow-x:hidden;max-height:72vh;scroll-behavior:smooth}
.row{border-top:1px solid var(--grid);background:transparent}
.cell{padding:10px 8px;font-size:calc(24px * var(--fs-base));white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.flag-left{font-size:30px; display:inline-flex; width:44px; justify-content:center; align-items:center}
.code{display:flex;align-items:center;gap:8px;flex-wrap:nowrap;min-width:0}
.code .tag{font-weight:900;opacity:.95}
.code .cn{font-weight:900;color:#fca5a5}
.code .th{opacity:.92;color:#a7f3d0;font-weight:800}
.code .country{opacity:.8;color:#93c5fd;font-weight:800}
.code .country::before{content:'Â· ';opacity:.8;color:#93c5fd}
.numWrap{display:flex;justify-content:center;gap:8px;align-items:center}
.num{min-width:8ch;text-align:center;font-variant-numeric:tabular-nums lining-nums;
     padding:6px 8px;border-radius:8px;transition:background .2s ease, box-shadow .2s ease;white-space:nowrap}
.num:focus{background:#0b1a2e;box-shadow:0 0 0 2px #294569 inset}
.buy{color:#ef4444;font-weight:900}.sell{color:#3b82f6;font-weight:900}.denom{font-weight:900;min-width:7ch;text-align:center}
.sub{opacity:.9}
.group-head{background:linear-gradient(180deg,rgba(255,255,255,.015),rgba(255,255,255,0));}
.group-tail{margin-bottom:2px;}
.page-indicator{position:absolute;bottom:10px;color:#9fb3c8;font-weight:800;background:rgba(0,0,0,.25);padding:6px 10px;border-radius:999px;border:1px solid #223049;z-index:3}
.pi-left{left:14px}
.pi-center{left:50%;transform:translateX(-50%)}
.pi-right{right:14px}
.hide{display:none !important}

/* å³ä¸‹è§’æŒ‰é’® */
#gearFloat{ position:fixed; right:16px; bottom:22px; z-index:999;
  background:#111827cc; border:1px solid #2b3648; color:#e5e7eb;
  border-radius:50%; width:52px; height:52px; display:flex; justify-content:center; align-items:center;
  font-size:24px; font-weight:700; cursor:pointer; transition:all .25s ease; box-shadow:0 8px 20px rgba(0,0,0,.35); }
#gearFloat:hover{ background:#1e293bcc; transform:scale(1.06); }
.controls-hidden .page-indicator.pi-right{ right:90px; } /* ç•™å‡ºç»™é½¿è½®æŒ‰é’® */

/* ç™»å½•æµ®é’®ï¼ˆæœªç™»å½•æ˜¾ç¤ºï¼‰ */
#loginFloat{ position:fixed; right:16px; bottom:22px; z-index:1000;
  background:#0b1222d9; border:1px solid #2b3648; color:#e5e7eb;
  border-radius:999px; height:44px; padding:0 14px; display:flex; gap:8px; justify-content:center; align-items:center;
  font-size:16px; font-weight:700; cursor:pointer; box-shadow:0 8px 20px rgba(0,0,0,.35); }

/* 900px ä»¥ä¸‹ï¼šæ›´ç´§å‡‘ */
@media (max-width: 900px){
  .thead,.row{grid-template-columns:64px 1fr minmax(120px,24vw) minmax(100px,18vw) minmax(100px,18vw)}
  .cell{font-size:calc(22px * var(--fs-base))}
  .th-c,.th-b,.th-s,.th-d{font-size:20px}
  header{grid-template-columns:1fr auto;gap:10px}
  .brand{display:none}
  .tb{max-height:70vh}
}

/* 430px ä»¥ä¸‹ï¼ˆæ‰‹æœºï¼‰ */
@media (max-width: 430px){
  .thead,.row{grid-template-columns:52px 1fr minmax(98px,30vw) minmax(84px,1fr) minmax(84px,1fr)}
  .cell{font-size:calc(18px * var(--fs-base))}
  .th-c,.th-b,.th-s,.th-d{font-size:18px}
  .flag-left{width:32px;font-size:22px}
  .code{gap:6px}
  .code .country, .code .th{display:none}
  .num{min-width:auto;padding:5px 6px}
  .page-indicator{left:50%; right:auto; transform:translateX(-50%);} /* é»˜è®¤åº•éƒ¨ä¸­é—´ */
  .tb{max-height:68vh}
  .btn{padding:6px 8px}
}
</style>
</head>
<body>

<!-- æœªç™»å½•æ˜¾ç¤ºçš„å°æŒ‰é’® -->
<button id="loginFloat" class="hide">ğŸ” ç™»å½•</button>
<!-- å·²ç™»å½•æ‰æ˜¾ç¤ºçš„é½¿è½®æŒ‰é’® -->
<div id="gearFloat" class="hide">âš™ï¸</div>

<div class="wrap" id="root">
  <header>
    <div class="brand">
      <svg class="logo" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" aria-label="å“ç‰ŒLOGO">
        <defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop offset="0" stop-color="#0b3b78"/><stop offset="1" stop-color="#122a4a"/></linearGradient></defs>
        <rect x="0" y="0" width="120" height="120" rx="24" fill="url(#g)"/>
        <circle cx="34" cy="40" r="16" fill="#f59e0b"/><path d="M18 84 L46 62 L70 78 L102 48" stroke="#22c55e" stroke-width="6" fill="none" stroke-linecap="round"/>
        <text x="60" y="48" text-anchor="middle" font-size="26" fill="#f59e0b" font-weight="800">Â¥</text>
      </svg>
      <div class="shopname">
        <div class="cn" id="shopCN">æ™ºèƒ½äº¤æ˜“æ‰€ Â· æ›¼è°·</div>
        <div class="en" id="shopEN">Intelligent Exchange Â· Bangkok</div>
        <div class="hours" id="hoursText">è¥ä¸šæ—¶é—´ï¼š24 å°æ—¶</div>
      </div>
    </div>

    <div class="controls hide" id="controls">
      <label class="btn" style="display:flex;gap:6px;align-items:center">
        è¯­è¨€
        <select id="lang" style="background:#0b1222;color:#e5e7eb;border:1px solid #2b3648;border-radius:8px;padding:6px">
          <option value="zh" selected>ä¸­æ–‡</option>
          <option value="th">à¹„à¸—à¸¢</option>
        </select>
      </label>

      <button class="btn" id="btn-cycle-toggle" title="æ’­æ”¾/æš‚åœè½®æ’­">â–¶ï¸ è½®æ’­æ’­æ”¾</button>

      <label class="btn" style="display:flex;gap:6px;align-items:center">
        <span id="labSpeed">é€Ÿåº¦</span> <input id="speed" type="range" min="0" max="60" step="1" value="6" style="width:120px">
        <input id="speedNum" type="number" min="0" max="120" step="1" value="6" style="width:54px;background:#0b1222;color:#e5e7eb;border:1px solid #2b3648;border-radius:8px;padding:6px">
        <span id="speedLabel">ç§’</span>
      </label>

      <label class="btn" style="display:flex;gap:6px;align-items:center">
        <span id="labPerPage">æ¯é¡µå›½å®¶</span> <input id="rppNum" type="number" min="2" max="8" step="1" value="3" style="width:46px;background:#0b1222;color:#e5e7eb;border:1px solid #2b3648;border-radius:8px;padding:6px">
      </label>

      <label class="btn" style="display:flex;gap:6px;align-items:center">
        <span id="labPi">é¡µç ä½ç½®</span>
        <select id="piPos" style="background:#0b1222;color:#e5e7eb;border:1px solid #2b3648;border-radius:8px;padding:6px">
          <option value="left">å·¦ä¸‹</option>
          <option value="center" selected>ä¸­ä¸‹</option>
          <option value="right">å³ä¸‹</option>
          <option value="hide">éšè—</option>
        </select>
      </label>

      <button class="btn" id="btn-pause-edit" aria-pressed="true" title="ç¼–è¾‘æ—¶è‡ªåŠ¨æš‚åœè½®æ’­">âœï¸ ç¼–è¾‘æš‚åœï¼šå¼€</button>

      <button class="btn" id="btn-add">â• æ·»åŠ å›½å®¶</button>

      <button class="btn" id="btn-full">å…¨å±</button>
      <button class="btn" id="btn-font-up">å­— +</button>
      <button class="btn" id="btn-font-down">å­— âˆ’</button>
      <button class="btn" id="btn-lock">ğŸ”“ ç¼–è¾‘ä¸­</button>

      <button class="btn" id="btn-export">å¯¼å‡º</button>
      <label class="btn" for="file" style="cursor:pointer">å¯¼å…¥</label>
      <input id="file" type="file" accept=".json" style="display:none" />
      <button class="btn" id="btn-undo">æ’¤é”€</button>
      <button class="btn" id="btn-wake">ğŸŒ™ å¸¸äº®ï¼šå…³</button>

      <button class="btn" id="btn-save">æœ¬æœºä¿å­˜</button>
      <button class="btn" id="btn-reset">æ¢å¤é»˜è®¤</button>
      <button class="btn" id="btn-hide">éšè—è®¾ç½®</button>

      <button class="btn" id="btn-logout">é€€å‡º</button>
      <span class="small" id="loginState"></span>
      <span class="small" id="cloudState">â˜ï¸ äº‘åŒæ­¥ï¼šå¼€</span>
    </div>

    <div class="clock">
      <div class="time" id="time">--:--:--</div>
      <div class="date" id="date">â€”</div>
    </div>
  </header>

  <section class="board">
    <div class="thead">
      <div class="cell"></div>
      <div class="cell th-c" id="thCurrency">Currency è´§å¸ Â· à¸ªà¸à¸¸à¸¥à¹€à¸‡à¸´à¸™</div>
      <div class="cell th-d" style="text-align:center" id="thDenom">Denomination é¢é¢</div>
      <div class="cell th-b" style="text-align:center" id="thBuy">BUY ä¹°å…¥</div>
      <div class="cell th-s" style="text-align:center" id="thSell">SELL å–å‡º</div>
    </div>
    <div class="tb">
      <div class="page" id="page"></div>
      <div class="page-indicator pi-center" id="pageIndicator">ç¬¬ 1 / 1 é¡µ</div>
    </div>
  </section>

  <footer>
    <div id="ftHotkeys">å¿«æ·é”®ï¼šF å…¨å± Â· E é”å®š Â· Space æ’­æ”¾/æš‚åœ Â· â†/â†’ æ¢é¡µ Â· H æ˜¾ç¤º/éšè—è®¾ç½®</div>
    <div>ä¸Šæ¬¡ä¿®æ”¹ï¼š<span id="updated">â€”</span></div>
    <div id="ftNote" style="text-align:right">æ±‡ç‡ä»…ä¾›å‚è€ƒï¼Œæˆäº¤ä»¥æŸœå°æŠ¥ä»·ä¸ºå‡†ã€‚</div>
  </footer>
</div>

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script>
window.FB_CONFIG = {"apiKey": "AIzaSyD0dEK5P8CHdHPUBFCNLQRBlSRuCtv3GIs", "authDomain": "znjys-b4c98.firebaseapp.com", "databaseURL": "https://znjys-b4c98-default-rtdb.asia-southeast1.firebasedatabase.app", "projectId": "znjys-b4c98", "storageBucket": "znjys-b4c98.firebasestorage.app", "messagingSenderId": "762313114991", "appId": "1:762313114991:web:092c17431572a281f0549a", "measurementId": "G-W835L9T6DG"};
</script>

<script>
// ===== å›ºå®šæˆ¿é—´ & I18N =====
const ROOM = 'bangkok';
const I18N = {
  zh:{cloud:'â˜ï¸ äº‘åŒæ­¥',cyclePlay:'â–¶ï¸ è½®æ’­æ’­æ”¾',cyclePause:'â¸ï¸ è½®æ’­æš‚åœ',speed:'é€Ÿåº¦',sec:'ç§’',noCycle:'ï¼ˆä¸è½®æ’­ï¼‰',perPage:'æ¯é¡µå›½å®¶',pagePos:'é¡µç ä½ç½®',left:'å·¦ä¸‹',center:'ä¸­ä¸‹',right:'å³ä¸‹',hide:'éšè—',pauseEditOn:'âœï¸ ç¼–è¾‘æš‚åœï¼šå¼€',pauseEditOff:'âœï¸ ç¼–è¾‘æš‚åœï¼šå…³',addCountry:'â• æ·»åŠ å›½å®¶',full:'å…¨å±',fontUp:'å­— +',fontDown:'å­— âˆ’',lockEditing:'ğŸ”“ ç¼–è¾‘ä¸­',locked:'ğŸ”’ å·²é”å®š',lockedReadOnly:'ğŸ”’ åªè¯»',export:'å¯¼å‡º',import:'å¯¼å…¥',undo:'æ’¤é”€',awake:'ğŸŒ™ å¸¸äº®',save:'æœ¬æœºä¿å­˜',reset:'æ¢å¤é»˜è®¤',hidePanel:'éšè—è®¾ç½®',login:'ç™»å½•',logout:'é€€å‡º',currencyHead:'Currency è´§å¸ Â· à¸ªà¸à¸¸à¸¥à¹€à¸‡à¸´à¸™',denomHead:'Denomination é¢é¢',buyHead:'BUY ä¹°å…¥',sellHead:'SELL å–å‡º',footerHotkeys:'å¿«æ·é”®ï¼šF å…¨å± Â· E é”å®š Â· Space æ’­æ”¾/æš‚åœ Â· â†/â†’ æ¢é¡µ Â· H æ˜¾ç¤º/éšè—è®¾ç½®',footerNote:'æ±‡ç‡ä»…ä¾›å‚è€ƒï¼Œæˆäº¤ä»¥æŸœå°æŠ¥ä»·ä¸ºå‡†ã€‚',promptAccount:'å‘˜å·¥è´¦å·ï¼ˆä¾‹å¦‚ znjysï¼‰',promptPwd:'å¯†ç ',added:'å·²æ·»åŠ ï¼š'},
  th:{cloud:'â˜ï¸ à¸‹à¸´à¸‡à¸à¹Œà¸„à¸¥à¸²à¸§à¸”à¹Œ',cyclePlay:'â–¶ï¸ à¹€à¸¥à¹ˆà¸™à¸ªà¸¥à¸±à¸šà¸«à¸™à¹‰à¸²',cyclePause:'â¸ï¸ à¸«à¸¢à¸¸à¸”à¸ªà¸¥à¸±à¸šà¸«à¸™à¹‰à¸²',speed:'à¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§',sec:'à¸§à¸´à¸™à¸²à¸—à¸µ',noCycle:'(à¹„à¸¡à¹ˆà¸ªà¸¥à¸±à¸š)',perPage:'à¸›à¸£à¸°à¹€à¸—à¸¨/à¸«à¸™à¹‰à¸²',pagePos:'à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¹€à¸¥à¸‚à¸«à¸™à¹‰à¸²',left:'à¸‹à¹‰à¸²à¸¢à¸¥à¹ˆà¸²à¸‡',center:'à¸à¸¥à¸²à¸‡à¸¥à¹ˆà¸²à¸‡',right:'à¸‚à¸§à¸²à¸¥à¹ˆà¸²à¸‡',hide:'à¸‹à¹ˆà¸­à¸™',pauseEditOn:'âœï¸ à¸«à¸¢à¸¸à¸”à¹€à¸¡à¸·à¹ˆà¸­à¹à¸à¹‰à¹„à¸‚: à¹€à¸›à¸´à¸”',pauseEditOff:'âœï¸ à¸«à¸¢à¸¸à¸”à¹€à¸¡à¸·à¹ˆà¸­à¹à¸à¹‰à¹„à¸‚: à¸›à¸´à¸”',addCountry:'â• à¹€à¸à¸´à¹ˆà¸¡à¸›à¸£à¸°à¹€à¸—à¸¨',full:'à¹€à¸•à¹‡à¸¡à¸«à¸™à¹‰à¸²à¸ˆà¸­',fontUp:'à¸‚à¸¢à¸²à¸¢+',fontDown:'à¸¢à¹ˆà¸­âˆ’',lockEditing:'ğŸ”“ à¹à¸à¹‰à¹„à¸‚à¸­à¸¢à¸¹à¹ˆ',locked:'ğŸ”’ à¸¥à¹‡à¸­à¸à¹à¸¥à¹‰à¸§',lockedReadOnly:'ğŸ”’ à¸­à¹ˆà¸²à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸”à¸µà¸¢à¸§',export:'à¸ªà¹ˆà¸‡à¸­à¸­à¸',import:'à¸™à¸³à¹€à¸‚à¹‰à¸²',undo:'à¸¢à¹‰à¸­à¸™à¸à¸¥à¸±à¸š',awake:'ğŸŒ™ à¹€à¸›à¸´à¸”à¸«à¸™à¹‰à¸²à¸ˆà¸­à¸„à¹‰à¸²à¸‡',save:'à¸šà¸±à¸™à¸—à¸¶à¸',reset:'à¸„à¸·à¸™à¸„à¹ˆà¸²à¹€à¸”à¸´à¸¡',hidePanel:'à¸‹à¹ˆà¸­à¸™à¹à¸œà¸‡',login:'à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š',logout:'à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š',currencyHead:'à¸ªà¸à¸¸à¸¥à¹€à¸‡à¸´à¸™ Â· Currency',denomHead:'à¸¡à¸¹à¸¥à¸„à¹ˆà¸²',buyHead:'à¸‹à¸·à¹‰à¸­ BUY',sellHead:'à¸‚à¸²à¸¢ SELL',footerHotkeys:'à¸›à¸¸à¹ˆà¸¡à¸¥à¸±à¸”: F à¹€à¸•à¹‡à¸¡à¸ˆà¸­ Â· E à¸¥à¹‡à¸­à¸ Â· Space à¹€à¸¥à¹ˆà¸™/à¸«à¸¢à¸¸à¸” Â· â†/â†’ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸«à¸™à¹‰à¸² Â· H à¸‹à¹ˆà¸­à¸™/à¹à¸ªà¸”à¸‡à¹à¸œà¸‡',footerNote:'à¸­à¸±à¸•à¸£à¸²à¹à¸¥à¸à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡ à¸£à¸²à¸„à¸²à¹€à¸›à¹‡à¸™à¹„à¸›à¸•à¸²à¸¡à¸«à¸™à¹‰à¸²à¹€à¸„à¸²à¸™à¹Œà¹€à¸•à¸­à¸£à¹Œ',promptAccount:'à¸šà¸±à¸à¸Šà¸µà¸à¸™à¸±à¸à¸‡à¸²à¸™ (à¹€à¸Šà¹ˆà¸™ znjys)',promptPwd:'à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™',added:'à¹€à¸à¸´à¹ˆà¸¡à¹à¸¥à¹‰à¸§: '}
};
const SETTINGS_KEY = 'exchange-board-settings-v27';
const DEFAULT_SETTINGS = { lang:'zh', speed: 6, pauseOnEdit: true, hiddenControls: true, fontScale: 1, locked:true, keepAwake:false, rpp: 3, piPos:'center'};
let SETTINGS = {...DEFAULT_SETTINGS};
try{ SETTINGS = {...SETTINGS, ...(JSON.parse(localStorage.getItem(SETTINGS_KEY))||{})}; }catch{}
function saveSettings(){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(SETTINGS)); }
function T(k){ const lang=SETTINGS.lang||'zh'; return (I18N[lang]&&I18N[lang][k])||k; }

// ===== UI refs =====
const controls = document.getElementById('controls');
const gear = document.getElementById('gearFloat');
const loginFloat = document.getElementById('loginFloat');
const pageEl = document.getElementById('page');
const pageIndicator = document.getElementById('pageIndicator');

// ===== çŠ¶æ€ =====
let locked = true;
let CAN_WRITE=false;
let baseScale = SETTINGS.fontScale || 1;
let currentPage = 0, pages = [], cycleTimer=null, isPausedManually=false, isEditing=false;
let applyingRemote=false;

// ===== æ•°æ® =====
const S = (n)=>(+n).toFixed(2);
const sanitize=(s)=>{ const n=parseFloat(String(s).replace(/[^0-9.\-]/g,'')); return isNaN(n)?null:Math.max(0,n); };
const STORE_KEY='exchange-cloud-v1-data-store';
const DEFAULT = [
  {flag:'ğŸ‡ºğŸ‡¸', cn:'ç¾å…ƒ', th:'à¸”à¸­à¸¥à¸¥à¸²à¸£à¹Œà¸ªà¸«à¸£à¸±à¸', en:'USD', country:'United States',
    items:[ {denom:'$1', buy:32.10, sell:32.60}, {denom:'$5â€“20', buy:32.40, sell:32.70}, {denom:'$100', buy:32.70, sell:32.73} ]},
  {flag:'ğŸ‡ªğŸ‡º', cn:'æ¬§å…ƒ', th:'à¸¢à¸¹à¹‚à¸£', en:'EUR', country:'European Union',
    items:[ {denom:'â‚¬5â€“20', buy:37.60, sell:37.95}, {denom:'â‚¬50', buy:37.80, sell:38.00}, {denom:'â‚¬100', buy:37.91, sell:38.05} ]},
  {flag:'ğŸ‡¬ğŸ‡§', cn:'è‹±é•‘', th:'à¸›à¸­à¸™à¸”à¹Œà¸­à¸±à¸‡à¸à¸¤à¸©', en:'GBP', country:'United Kingdom',
    items:[ {denom:'Â£5â€“20', buy:43.10, sell:43.50}, {denom:'Â£50', buy:43.40, sell:43.60}, {denom:'Â£100', buy:43.51, sell:43.65} ]},
  {flag:'ğŸ‡¨ğŸ‡³', cn:'äººæ°‘å¸', th:'à¸«à¸¢à¸§à¸™à¸ˆà¸µà¸™', en:'CNY', country:'China',
    items:[ {denom:'Â¥10â€“50', buy:4.55, sell:4.62}, {denom:'Â¥100', buy:4.61, sell:4.65}, {denom:'Â¥200+', buy:4.62, sell:4.66} ]},
  {flag:'ğŸ‡¸ğŸ‡¬', cn:'æ–°å…ƒ', th:'à¸”à¸­à¸¥à¸¥à¸²à¸£à¹Œà¸ªà¸´à¸‡à¸„à¹‚à¸›à¸£à¹Œ', en:'SGD', country:'Singapore',
    items:[ {denom:'$20â€“5', buy:27.00, sell:27.30}, {denom:'$50â€“100', buy:27.30, sell:27.55}, {denom:'$1000', buy:27.25, sell:27.40} ]},
  {flag:'ğŸ‡¦ğŸ‡º', cn:'æ¾³å…ƒ', th:'à¸”à¸­à¸¥à¸¥à¸²à¸£à¹Œà¸­à¸­à¸ªà¹€à¸•à¸£à¹€à¸¥à¸µà¸¢', en:'AUD', country:'Australia',
    items:[ {denom:'$5â€“20', buy:20.90, sell:21.20}, {denom:'$50â€“100', buy:21.13, sell:21.30}, {denom:'$500+', buy:21.20, sell:21.35} ]},
  {flag:'ğŸ‡¨ğŸ‡¦', cn:'åŠ å…ƒ', th:'à¸”à¸­à¸¥à¸¥à¸²à¸£à¹Œà¹à¸„à¸™à¸²à¸”à¸²', en:'CAD', country:'Canada',
    items:[ {denom:'$5â€“20', buy:23.10, sell:23.35}, {denom:'$50â€“100', buy:23.25, sell:23.45}, {denom:'$500+', buy:23.30, sell:23.55} ]},
  {flag:'ğŸ‡­ğŸ‡°', cn:'æ¸¯å¸', th:'à¸”à¸­à¸¥à¸¥à¸²à¸£à¹Œà¸®à¹ˆà¸­à¸‡à¸à¸‡', en:'HKD', country:'Hong Kong',
    items:[ {denom:'$20â€“50', buy:4.18, sell:4.21}, {denom:'$100â€“500', buy:4.21, sell:4.22}, {denom:'$1000', buy:4.215, sell:4.225} ]},
  {flag:'ğŸ‡²ğŸ‡¾', cn:'é©¬å¸', th:'à¸£à¸´à¸‡à¸à¸´à¸•à¸¡à¸²à¹€à¸¥à¹€à¸‹à¸µà¸¢', en:'MYR', country:'Malaysia',
    items:[ {denom:'5â€“20', buy:7.60, sell:7.72}, {denom:'50â€“100', buy:7.68, sell:7.76}, {denom:'500+', buy:7.70, sell:7.78} ]},
  {flag:'ğŸ‡°ğŸ‡·', cn:'éŸ©å…ƒ', th:'à¸§à¸­à¸™à¹€à¸à¸²à¸«à¸¥à¸µ', en:'KRW', country:'South Korea',
    items:[ {denom:'â‚©1kâ€“5k', buy:0.0235, sell:0.0245}, {denom:'â‚©10k', buy:0.024, sell:0.025}, {denom:'â‚©50k', buy:0.0242, sell:0.0252} ]}
];
let DATA = JSON.parse(JSON.stringify(DEFAULT));

// ===== æ¸²æŸ“ =====
function buildRows(){ const rows=[]; DATA.forEach((g,gi)=>g.items.forEach((it,si)=>rows.push({gi,si, showHead: si===0}))); return rows; }
function setupEditable(scopeEl){
  scopeEl.querySelectorAll('[contenteditable]').forEach(el=>{
    el.addEventListener('focus', ()=>{ isEditing = true; if(SETTINGS.pauseOnEdit) updateCycleState(); });
    el.addEventListener('keydown', e=>{
      if(e.key==='Enter'){ e.preventDefault(); el.blur(); }
      if(e.key==='Escape'){
        e.preventDefault();
        const gi=+scopeEl.dataset.gi, si=+scopeEl.dataset.si, k=el.dataset.key;
        if(k==='buy'||k==='sell'){ el.textContent = S(DATA[gi].items[si][k]); }
        else if(k==='denom'){ el.textContent = DATA[gi].items[si].denom; }
        else { el.textContent = DATA[gi][k] || ''; }
        el.blur();
      }
    });
    el.addEventListener('blur', ()=>{
      if(!CAN_WRITE){ isEditing=false; return; } // æœªç™»å½•åªè¯»
      const gi=+scopeEl.dataset.gi, si=+scopeEl.dataset.si, k=el.dataset.key;
      if(k==='buy' || k==='sell'){
        const v = sanitize(el.textContent);
        if(v==null){ el.textContent = S(DATA[gi].items[si][k]); return; }
        DATA[gi].items[si][k] = v; el.textContent = S(v); touch();
      }else if(k==='denom'){
        DATA[gi].items[si].denom = (el.textContent||'').trim() || 'â€”'; touch();
      }else{
        DATA[gi][k] = (el.textContent||'').trim(); touch(); render();
      }
      setTimeout(()=>{ isEditing = false; if(SETTINGS.pauseOnEdit) updateCycleState(); }, 120);
    });
  });
}
function drawPage(p){
  const rows = pages[p];
  pageEl.innerHTML = '';
  let lastGi=-1;
  rows.forEach((r, idx)=>{
    const g = DATA[r.gi]; const it = g.items[r.si];
    const head = (r.gi!==lastGi);
    if(head){
      const headRow = document.createElement('div');
      headRow.className='row group-head';
      headRow.dataset.gi=r.gi; headRow.dataset.si=-1;
      headRow.innerHTML=`
        <div class="cell"><span class="flag-left ${locked?'':'edit'}" ${locked?'':'contenteditable'} data-key="flag">${g.flag}</span></div>
        <div class="cell code">
          <span class="cn ${locked?'':'edit'}" ${locked?'':'contenteditable'} data-key="cn">${g.cn}</span>
          <span class="tag ${locked?'':'edit'}" ${locked?'':'contenteditable'} data-key="en">${g.en}</span>
          <span class="th ${locked?'':'edit'}" ${locked?'':'contenteditable'} data-key="th">${g.th}</span>
          <span class="country ${locked?'':'edit'}" ${locked?'':'contenteditable'} data-key="country">${g.country}</span>
        </div>
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>
      `;
      setupEditable(headRow);
      pageEl.appendChild(headRow);
    }
    lastGi=r.gi;
    const row=document.createElement('div');
    row.className='row sub'+(idx===rows.length-1?' group-tail':'');
    row.dataset.gi=r.gi; row.dataset.si=r.si;
    row.innerHTML=`
      <div class="cell"></div>
      <div class="cell code"></div>
      <div class="cell"><div class="numWrap"><div class="num denom ${locked?'':'edit'}" ${locked?'':'contenteditable'} data-key="denom">${it.denom}</div></div></div>
      <div class="cell"><div class="numWrap"><div class="num buy ${locked?'':'edit'}" ${locked?'':'contenteditable'} data-key="buy">${S(it.buy)}</div></div></div>
      <div class="cell"><div class="numWrap"><div class="num sell ${locked?'':'edit'}" ${locked?'':'contenteditable'} data-key="sell">${S(it.sell)}</div></div></div>
    `;
    setupEditable(row);
    pageEl.appendChild(row);
  });
}
function render(){
  const rows=buildRows();
  const RPP=(SETTINGS.rpp||3)*3;
  pages=[];
  for(let i=0;i<rows.length;i+=RPP){ pages.push(rows.slice(i,i+RPP)); }
  if(pages.length===0) pages=[[]];
  currentPage=Math.min(currentPage, pages.length-1);
  drawPage(currentPage);
  pageIndicator.textContent = `ç¬¬ ${currentPage+1} / ${pages.length} é¡µ`;
  setPiPos(SETTINGS.piPos||'center');
  updateCycleState();
}

// ===== è½®æ’­ =====
function updateCycleState(){
  if(cycleTimer) clearInterval(cycleTimer); cycleTimer=null;
  const canPlay = (SETTINGS.speed>0) && (pages.length>1) && !isPausedManually && !(SETTINGS.pauseOnEdit && isEditing);
  document.getElementById('btn-cycle-toggle').textContent = canPlay ? T('cyclePause') : T('cyclePlay');
  if(canPlay){ cycleTimer = setInterval(()=>{ nextPage(); }, SETTINGS.speed*1000); }
}
function nextPage(){ if(pages.length<=1) return; currentPage=(currentPage+1)%pages.length; drawPage(currentPage); pageIndicator.textContent = `ç¬¬ ${currentPage+1} / ${pages.length} é¡µ`; }

// ===== æ§ä»¶ =====
function setPiPos(pos){ const el = pageIndicator; el.classList.remove('pi-left','pi-center','pi-right'); if(pos==='left') el.classList.add('pi-left'); else if(pos==='right') el.classList.add('pi-right'); else if(pos==='center') el.classList.add('pi-center'); el.classList.toggle('hide', pos==='hide'); }
function setSpeed(sec){
  const s = Math.max(0, Math.min(120, Math.floor(Number(sec)||0)));
  SETTINGS.speed=s; saveSettings();
  document.getElementById('speed').value=s;
  document.getElementById('speedNum').value=s;
  document.getElementById('speedLabel').textContent=(s===0? T('noCycle'):T('sec'));
  updateCycleState();
}
function setRpp(n){ const rpp=Math.max(2, Math.min(8, Math.floor(Number(n)||3))); SETTINGS.rpp=rpp; saveSettings(); document.getElementById('rppNum').value=rpp; render(); }
const hintEl = document.getElementById('hint');
function hint(s){ hintEl.textContent=s; setTimeout(()=>{ if(hintEl.textContent===s) hintEl.textContent=''; }, 3000); }

document.getElementById('btn-full').onclick=()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); };
document.getElementById('btn-lock').onclick=()=>{ locked=!locked; SETTINGS.locked=locked; saveSettings(); document.getElementById('btn-lock').textContent=locked? T('locked'):T('lockEditing'); render(); };
document.getElementById('btn-font-up').onclick=()=>{ baseScale=Math.min(2.4, (baseScale||1)+0.06); SETTINGS.fontScale=baseScale; saveSettings(); document.documentElement.style.setProperty('--fs-base', String(baseScale)); render(); };
document.getElementById('btn-font-down').onclick=()=>{ baseScale=Math.max(0.6, (baseScale||1)-0.06); SETTINGS.fontScale=baseScale; saveSettings(); document.documentElement.style.setProperty('--fs-base', String(baseScale)); render(); };
document.getElementById('btn-save').onclick=()=>{ localStorage.setItem(STORE_KEY, JSON.stringify(DATA)); alert('å·²ä¿å­˜åˆ°æœ¬æœº'); };
document.getElementById('btn-reset').onclick=()=>{ if(confirm('ç¡®å®šæ¢å¤é»˜è®¤ï¼Ÿå°†è¦†ç›–å½“å‰æ›´æ”¹ã€‚')){ DATA = JSON.parse(JSON.stringify(DEFAULT)); touch(); render(); pushNow(); }};
document.getElementById('btn-export').onclick=()=>{ const blob = new Blob([JSON.stringify(DATA,null,2)], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='æ±‡ç‡æ•°æ®.json'; document.body.appendChild(a); a.click(); a.remove(); };
document.getElementById('file').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>{ try{ DATA=JSON.parse(reader.result); touch(); render(); }catch{ alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®'); } }; reader.readAsText(f,'utf-8'); e.target.value=''; });
document.getElementById('btn-undo').onclick=()=>{ alert('ä¸ºç¨³å®šèµ·è§ï¼Œæœ¬ç‰ˆä¸æä¾›å¤šæ­¥æ’¤é”€'); };
document.getElementById('btn-wake').onclick=()=>setWake(!SETTINGS.keepAwake);
document.getElementById('btn-cycle-toggle').onclick=()=>{ isPausedManually=!isPausedManually; updateCycleState(); };
document.getElementById('speed').addEventListener('input', e=>setSpeed(e.target.value));
document.getElementById('speedNum').addEventListener('change', e=>setSpeed(e.target.value));
document.getElementById('rppNum').addEventListener('change', e=>setRpp(e.target.value));
document.getElementById('piPos').addEventListener('change', e=>{ SETTINGS.piPos=e.target.value; saveSettings(); setPiPos(SETTINGS.piPos); });
const pauseBtn=document.getElementById('btn-pause-edit');
pauseBtn.onclick=()=>{ SETTINGS.pauseOnEdit=!SETTINGS.pauseOnEdit; pauseBtn.setAttribute('aria-pressed', SETTINGS.pauseOnEdit?'true':'false'); pauseBtn.textContent = SETTINGS.pauseOnEdit? T('pauseEditOn'):T('pauseEditOff'); saveSettings(); updateCycleState(); };
document.getElementById('btn-hide').onclick=()=>setControlsHidden(true);
document.getElementById('lang').addEventListener('change', e=>{ SETTINGS.lang=e.target.value; saveSettings(); applyI18N(); });

// å¸¸äº®
let wakeLock=null;
async function setWake(on){
  SETTINGS.keepAwake = !!on; saveSettings();
  const btn=document.getElementById('btn-wake');
  if(!('wakeLock' in navigator)){ btn.textContent=T('awake')+'ï¼šä¸æ”¯æŒ'; return; }
  try{
    if(SETTINGS.keepAwake){ wakeLock=await navigator.wakeLock.request('screen'); btn.textContent=T('awake')+'ï¼šå¼€'; wakeLock.addEventListener('release',()=>{btn.textContent=T('awake')+'ï¼šå…³'; SETTINGS.keepAwake=false; saveSettings();}); }
    else{ if(wakeLock){ wakeLock.release(); wakeLock=null; } btn.textContent=T('awake')+'ï¼šå…³'; }
  }catch(e){ console.warn(e); btn.textContent=T('awake')+'ï¼šå¤±è´¥'; }
}

// ===== éšè—/æ˜¾ç¤ºè®¾ç½® =====
function setControlsHidden(hide){
  SETTINGS.hiddenControls = !!hide; saveSettings();
  controls.classList.toggle('hide', SETTINGS.hiddenControls);
  gear.classList.toggle('hide', !SETTINGS.hiddenControls && CAN_WRITE);
  document.body.classList.toggle('controls-hidden', SETTINGS.hiddenControls);
}
gear.onclick=()=>setControlsHidden(false);

// ===== æœ¬åœ° & äº‘åŒæ­¥ =====
function touch(){ localStorage.setItem(STORE_KEY, JSON.stringify(DATA)); document.getElementById('updated').textContent = new Date().toLocaleString(); if(!applyingRemote) pushNow(); }

// ===== Firebaseï¼šé»˜è®¤äº‘åŒæ­¥å¼€å¯ =====
let app=null, db=null, ref=null, auth=null;
let cloudOn=false;

function cloudEnable(on){
  if(on===cloudOn) return;
  if(on){
    try{
      app = firebase.apps?.length ? firebase.app() : firebase.initializeApp(FB_CONFIG);
      db = firebase.database();
      ref = db.ref('exchange/cloud/v1/'+ROOM);
      ref.on('value', snap=>{
        const v=snap.val(); if(!v) return;
        applyingRemote=true; if(v.data) DATA=v.data;
        document.getElementById('updated').textContent = new Date(v.updated||Date.now()).toLocaleString();
        render(); applyingRemote=false;
      });
      cloudOn = true; document.getElementById('cloudState').textContent=T('cloud')+'ï¼šå¼€';
      pushNow();
    }catch(e){ console.error(e); alert('è¿æ¥ Firebase å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®'); }
  }else{
    if(ref){ ref.off(); ref=null; }
    cloudOn = false; document.getElementById('cloudState').textContent=T('cloud')+'ï¼šå…³';
  }
}
function pushNow(){ if(!cloudOn || !ref || !CAN_WRITE) return; ref.set({ data: DATA, updated: Date.now() }); }

// ===== ç™»å½•ï¼ˆæœªç™»å½•éšè—è®¾ç½®ï¼›ç™»å½•åæ˜¾ç¤ºè®¾ç½®ï¼‰ =====
function updateLoginUI(u){
  if(u){
    document.getElementById('loginState').textContent = u.email || '';
    CAN_WRITE=false; // å¾…æŸ¥è§’è‰²
    firebase.database().ref('roles/'+u.uid+'/write').once('value').then(s=>{
      CAN_WRITE = (s.val()===true);
      locked = !CAN_WRITE ? true : (SETTINGS.locked!==undefined?SETTINGS.locked:false);
      setControlsHidden(false); // æ˜¾ç¤ºè®¾ç½®
      loginFloat.classList.add('hide'); // éšè—ç™»å½•æŒ‰é’®
      gear.classList.remove('hide'); // æ˜¾ç¤ºé½¿è½®
      document.getElementById('btn-lock').textContent = locked? T('locked'):T('lockEditing');
      render();
    });
  }else{
    document.getElementById('loginState').textContent = 'æœªç™»å½•ï¼ˆåªè¯»ï¼‰';
    CAN_WRITE=false; locked=true;
    setControlsHidden(true); // éšè—è®¾ç½®
    loginFloat.classList.remove('hide'); // æ˜¾ç¤ºç™»å½•æŒ‰é’®
    gear.classList.add('hide'); // éšè—é½¿è½®
    render();
  }
}

function initAuth(){
  auth = firebase.auth();
  auth.onAuthStateChanged(updateLoginUI);
}
loginFloat.onclick=async()=>{
  try{
    if(!auth) initAuth();
    const acc = prompt(T('promptAccount')+'ï¼š','znjys'); if(!acc) return;
    const pwd = prompt(T('promptPwd')+'ï¼š','5201314'); if(!pwd) return;
    const email = (acc.trim()||'znjys')+'@znjys.local';
    await auth.signInWithEmailAndPassword(email, pwd);
    alert('ç™»å½•æˆåŠŸ');
  }catch(e){ alert('ç™»å½•å¤±è´¥ï¼š'+(e?.message||'')); }
};
document.getElementById('btn-logout').onclick=async()=>{ try{ await auth.signOut(); alert('å·²é€€å‡º'); }catch(e){} };

// ===== I18N åº”ç”¨ =====
function applyI18N(){
  document.getElementById('lang').value = SETTINGS.lang||'zh';
  document.getElementById('btn-cycle-toggle').textContent = (cycleTimer? T('cyclePause'):T('cyclePlay'));
  document.getElementById('labSpeed').textContent = T('speed');
  document.getElementById('speedLabel').textContent = SETTINGS.speed===0 ? T('noCycle') : T('sec');
  document.getElementById('labPerPage').textContent = T('perPage');
  document.getElementById('labPi').textContent = T('pagePos');
  pauseBtn.textContent = SETTINGS.pauseOnEdit? T('pauseEditOn'):T('pauseEditOff');
  document.getElementById('btn-add').textContent = T('addCountry');
  document.getElementById('btn-full').textContent = T('full');
  document.getElementById('btn-font-up').textContent = T('fontUp');
  document.getElementById('btn-font-down').textContent = T('fontDown');
  document.getElementById('btn-lock').textContent = locked? T('locked'):T('lockEditing');
  document.getElementById('btn-export').textContent = T('export');
  document.querySelector('label[for="file"]').textContent = T('import');
  document.getElementById('btn-undo').textContent = T('undo');
  document.getElementById('btn-wake').textContent = T('awake')+'ï¼š'+(SETTINGS.keepAwake?'å¼€':'å…³');
  document.getElementById('btn-save').textContent = T('save');
  document.getElementById('btn-reset').textContent = T('reset');
  document.getElementById('btn-hide').textContent = T('hidePanel');
  document.getElementById('btn-logout').textContent = T('logout');
  document.getElementById('thCurrency').textContent = T('currencyHead');
  document.getElementById('thDenom').textContent = T('denomHead');
  document.getElementById('thBuy').textContent = T('buyHead');
  document.getElementById('thSell').textContent = T('sellHead');
  document.getElementById('ftHotkeys').textContent = T('footerHotkeys');
  document.getElementById('ftNote').textContent = T('footerNote');
}

// ===== Init =====
(function init(){
  // æœ¬åœ°æ•°æ®
  const saved = localStorage.getItem(STORE_KEY); if(saved){ try{ DATA = JSON.parse(saved) || DATA; }catch{} }
  // è®¾ç½®
  document.documentElement.style.setProperty('--fs-base', String(baseScale||1));
  setSpeed(SETTINGS.speed||6);
  setRpp(SETTINGS.rpp||3);
  setPiPos(SETTINGS.piPos||'center');
  applyI18N();
  render();
  document.getElementById('updated').textContent = new Date().toLocaleString();
  // é»˜è®¤äº‘åŒæ­¥å¼€å¯
  cloudEnable(true);
  // åˆå§‹åŒ–è®¤è¯ç›‘å¬ï¼ˆç”¨äºè‡ªåŠ¨éšè—/æ˜¾ç¤ºè®¾ç½®é¢æ¿ï¼‰
  initAuth();
})();

// æ—¶é’Ÿ
(function tick(){ const n=new Date(); document.getElementById('time').textContent=n.toLocaleTimeString(); document.getElementById('date').textContent=n.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric',weekday:'long'}); setTimeout(tick,1000); })();
</script>
</body>
</html>
