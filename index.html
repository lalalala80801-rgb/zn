<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>æ™ºèƒ½äº¤æ˜“æ‰€ Â· æ›¼è°· Â· äº‘åŒæ­¥ï¼ˆå®‰å…¨ç®¡ç† v2.8ï¼‰</title>
<style>
:root{
  --bg:#0a0f1a; --panel:#0f172a; --panel2:#0b1324; --text:#e5e7eb; --muted:#9fb3af;
  --buy:#ef4444; --sell:#3b82f6; --grid:#1f2a3d; --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,#0b1b30 10%,#0a0f1a 60%);color:var(--text);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif}
.wrap{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
header{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;padding:12px 14px}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{background:#111827;border:1px solid #2b3648;border-radius:10px;color:#e5e7eb;padding:7px 10px;font-weight:600;cursor:pointer}
.btn:hover{background:#0f172a}
.small{font-size:12px;opacity:.85}
.clock{text-align:right}.clock .time{font-size:22px;font-weight:800}.clock .date{font-size:12px;opacity:.9}
.board{background:linear-gradient(180deg,#0f172a,#0b1324);border:1px solid #233146;border-radius:var(--radius);overflow:hidden;margin:12px 14px}
.thead,.row{display:grid;grid-template-columns:88px 1fr 220px 190px 190px;align-items:center}
.thead{background:#0e1527;border-bottom:1px solid #233146;position:sticky;top:0;z-index:2}
.cell{padding:10px 8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:22px}
.tb{max-height:72vh;overflow:hidden;position:relative}
.page{overflow-y:auto;max-height:72vh}
.num{min-width:8ch;text-align:center;padding:6px 8px;border-radius:8px}
.buy{color:var(--buy);font-weight:900}.sell{color:var(--sell);font-weight:900}.denom{font-weight:900;min-width:7ch;text-align:center}
.page-indicator{position:absolute;left:50%;bottom:10px;transform:translateX(-50%);background:rgba(0,0,0,.25);border:1px solid #223049;border-radius:999px;padding:6px 10px;font-weight:800}
footer{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;padding:10px 14px;border-top:1px solid #233146;color:#9fb3c8}

/* ç™»å½•å…¥å£ï¼šé»˜è®¤éšè—ï¼Œ?admin=1 æ‰æ˜¾ç¤º */
#loginFloat{position:fixed;right:16px;bottom:22px;z-index:1000;background:#0b1222d9;border:1px solid #2b3648;color:#e5e7eb;border-radius:999px;height:44px;padding:0 14px;display:none;gap:8px;justify-content:center;align-items:center;font-weight:700;box-shadow:0 8px 20px rgba(0,0,0,.35)}

/* ç™»å½•å¼¹çª— */
#loginDlg{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1200}
#loginPanel{background:#0b1222;border:1px solid #2b3648;border-radius:14px;width:min(420px,92vw);padding:16px}
#loginPanel h3{margin:0 0 10px 0}
.form-row{display:flex;gap:8px;align-items:center;margin:8px 0}
.form-row label{width:80px;color:#9fb3c8}
.form-row input,.form-row textarea,.form-row select{flex:1;background:#0b1222;color:#e5e7eb;border:1px solid #2b3648;border-radius:8px;padding:10px}
.form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

/* å•†å®¶ä¿¡æ¯å¡ç‰‡ */
#shopCard{position:fixed;z-index:900;background:#0b1222cc;border:1px solid #2b3648;border-radius:14px;padding:12px;backdrop-filter:blur(4px)}
#shopCard.small{width:200px} #shopCard.medium{width:260px} #shopCard.large{width:320px}
#shopCard h4{margin:0 0 6px 0}
#shopCard .row{display:block}
.qrs{display:flex;gap:10px;margin-top:6px}
.qrs figure{margin:0;text-align:center}
.qrs img{width:90px;height:90px;border-radius:8px;border:1px solid #2b3648;background:#0b1222}
.pos-lt{left:12px;top:12px} .pos-rt{right:12px;top:12px} .pos-lb{left:12px;bottom:12px} .pos-rb{right:12px;bottom:12px}

/* å“åº”å¼ */
@media (max-width: 900px){
  .thead,.row{grid-template-columns:64px 1fr minmax(120px,24vw) minmax(100px,18vw) minmax(100px,18vw)}
  .cell{font-size:20px}
}
@media (max-width: 430px){
  .thead,.row{grid-template-columns:52px 1fr minmax(98px,30vw) minmax(84px,1fr) minmax(84px,1fr)}
  .cell{font-size:18px}
  .page-indicator{left:50%;right:auto;transform:translateX(-50%)}
}
</style>
</head>
<body>
<button id="loginFloat">ğŸ” ç™»å½•</button>

<div class="wrap">
  <header>
    <div style="font-weight:900;font-size:20px">æ™ºèƒ½äº¤æ˜“æ‰€ Â· æ›¼è°·</div>
    <div class="controls" id="controls" style="display:none">
      <button class="btn" id="btn-cycle">â–¶ï¸ è½®æ’­æ’­æ”¾</button>
      <label class="btn">é€Ÿåº¦
        <input id="speed" type="range" min="0" max="60" step="1" value="6" style="width:120px">
        <input id="speedNum" type="number" min="0" max="120" step="1" value="6" style="width:54px;background:#0b1222;color:#e5e7eb;border:1px solid #2b3648;border-radius:8px;padding:6px">
        <span id="speedLabel">ç§’</span>
      </label>
      <label class="btn">æ¯é¡µå›½å®¶ <input id="rppNum" type="number" min="2" max="8" step="1" value="3" style="width:46px;background:#0b1222;color:#e5e7eb;border:1px solid #2b3648;border-radius:8px;padding:6px"></label>
      <button class="btn" id="btn-lock">ğŸ”’ å·²é”å®š</button>

      <button class="btn" id="btn-shop-toggle">å•†å®¶ä¿¡æ¯ï¼šå…³</button>
      <button class="btn" id="btn-shop-edit">ç¼–è¾‘å•†å®¶ä¿¡æ¯</button>

      <button class="btn" id="btn-logout">é€€å‡º</button>
      <span class="small" id="loginState"></span>
      <span class="small" id="cloudState">â˜ï¸ äº‘åŒæ­¥ï¼šå¼€</span>
    </div>
    <div class="clock">
      <div class="time" id="time">--:--:--</div>
      <div class="date" id="date">â€”</div>
    </div>
  </header>

  <section class="board">
    <div class="thead">
      <div class="cell"></div>
      <div class="cell">Currency è´§å¸ Â· à¸ªà¸à¸¸à¸¥à¹€à¸‡à¸´à¸™</div>
      <div class="cell" style="text-align:center">Denomination é¢é¢</div>
      <div class="cell" style="text-align:center;color:#ef4444;font-weight:900">BUY ä¹°å…¥</div>
      <div class="cell" style="text-align:center;color:#3b82f6;font-weight:900">SELL å–å‡º</div>
    </div>
    <div class="tb">
      <div class="page" id="page"></div>
      <div class="page-indicator" id="pageIndicator">ç¬¬ 1 / 1 é¡µ</div>
    </div>
  </section>

  <footer>
    <div>å¿«æ·é”®ï¼šF å…¨å± Â· Space æ’­æ”¾/æš‚åœ Â· â†/â†’ æ¢é¡µ</div>
    <div>ä¸Šæ¬¡ä¿®æ”¹ï¼š<span id="updated">â€”</span></div>
    <div style="text-align:right">æ±‡ç‡ä»…ä¾›å‚è€ƒï¼Œæˆäº¤ä»¥æŸœå°æŠ¥ä»·ä¸ºå‡†ã€‚</div>
  </footer>
</div>

<!-- å•†å®¶ä¿¡æ¯å¡ç‰‡ -->
<aside id="shopCard" class="medium pos-rb" style="display:none">
  <h4 id="sc-name">æ™ºèƒ½äº¤æ˜“æ‰€ Â· æ›¼è°·</h4>
  <div id="sc-addr" class="row"></div>
  <div id="sc-phone" class="row"></div>
  <div id="sc-note" class="row" style="opacity:.9"></div>
  <div class="qrs">
    <figure id="fig-wechat" style="display:none">
      <img id="sc-wechat" alt="å¾®ä¿¡äºŒç»´ç "><figcaption style="font-size:12px;opacity:.85">å¾®ä¿¡</figcaption>
    </figure>
    <figure id="fig-line" style="display:none">
      <img id="sc-line" alt="Line äºŒç»´ç "><figcaption style="font-size:12px;opacity:.85">Line</figcaption>
    </figure>
  </div>
</aside>

<!-- ç™»å½•å¼¹çª—ï¼ˆç¦ç”¨è‡ªåŠ¨å¡«å……ï¼‰ -->
<div id="loginDlg">
  <div id="loginPanel">
    <h3>å‘˜å·¥ç™»å½•</h3>
    <form id="loginForm" autocomplete="off">
      <div class="form-row">
        <label for="acc">è´¦å·</label>
        <input id="acc" name="acc_x" type="text" inputmode="latin" autocomplete="off" placeholder="ä¾‹å¦‚ znjys">
      </div>
      <div class="form-row">
        <label for="pwd">å¯†ç </label>
        <input id="pwd" name="pwd_x" type="password" autocomplete="new-password" placeholder="ä¾‹å¦‚ 5201314">
      </div>
      <div class="form-actions">
        <button type="button" class="btn" id="btnCancel">å–æ¶ˆ</button>
        <button type="submit" class="btn">ç™»å½•</button>
      </div>
    </form>
  </div>
</div>

<!-- å•†å®¶ä¿¡æ¯ç¼–è¾‘å¼¹çª— -->
<div id="shopDlg" style="position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1200">
  <div style="background:#0b1222;border:1px solid #2b3648;border-radius:14px;width:min(560px,94vw);padding:16px">
    <h3 style="margin:0 0 10px 0">ç¼–è¾‘å•†å®¶ä¿¡æ¯</h3>
    <div class="form-row"><label>æ˜¾ç¤º</label>
      <select id="f_on"><option value="true">å¼€</option><option value="false">å…³</option></select>
    </div>
    <div class="form-row"><label>ä½ç½®</label>
      <select id="f_pos">
        <option value="rb">å³ä¸‹</option><option value="lb">å·¦ä¸‹</option><option value="rt">å³ä¸Š</option><option value="lt">å·¦ä¸Š</option>
      </select>
    </div>
    <div class="form-row"><label>å¤§å°</label>
      <select id="f_size"><option value="small">å°</option><option value="medium">ä¸­</option><option value="large">å¤§</option></select>
    </div>
    <div class="form-row"><label>ä¸­æ–‡å</label><input id="f_name_cn" placeholder="æ™ºèƒ½äº¤æ˜“æ‰€ Â· æ›¼è°·"></div>
    <div class="form-row"><label>è‹±æ–‡å</label><input id="f_name_en" placeholder="Intelligent Exchange Â· Bangkok"></div>
    <div class="form-row"><label>åœ°å€</label><textarea id="f_addr" rows="2" placeholder="åœ°å€"></textarea></div>
    <div class="form-row"><label>ç”µè¯</label><input id="f_phone" placeholder="ç”µè¯"></div>
    <div class="form-row"><label>å¤‡æ³¨</label><input id="f_note" placeholder="ä¾‹å¦‚ï¼šè¥ä¸šæ—¶é—´ 24 å°æ—¶"></div>
    <div class="form-row"><label>å¾®ä¿¡ID</label><input id="f_wechat_id" placeholder="å¯é€‰"></div>
    <div class="form-row"><label>Line ID</label><input id="f_line_id" placeholder="å¯é€‰"></div>
    <div class="form-row"><label>å¾®ä¿¡äºŒç»´ç </label><input id="f_wechat_qr" type="file" accept="image/*"></div>
    <div class="form-row"><label>Line äºŒç»´ç </label><input id="f_line_qr" type="file" accept="image/*"></div>
    <div class="form-actions">
      <button class="btn" id="btnShopCancel">å–æ¶ˆ</button>
      <button class="btn" id="btnShopSave">ä¿å­˜</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script>
// ====== Firebase é…ç½® ======
window.FB_CONFIG = {"apiKey": "AIzaSyD0dEK5P8CHdHPUBFCNLQRBlSRuCtv3GIs", "authDomain": "znjys-b4c98.firebaseapp.com", "databaseURL": "https://znjys-b4c98-default-rtdb.asia-southeast1.firebasedatabase.app", "projectId": "znjys-b4c98", "storageBucket": "znjys-b4c98.firebasestorage.app", "messagingSenderId": "762313114991", "appId": "1:762313114991:web:092c17431572a281f0549a", "measurementId": "G-W835L9T6DG"};

// ====== ç®¡ç†å‘˜å…¥å£ï¼š?admin=1 æ‰æ˜¾ç¤ºâ€œç™»å½•â€æŒ‰é’® ======
if (new URLSearchParams(location.search).get('admin') === '1') {
  document.getElementById('loginFloat').style.display = 'flex';
}

// ====== å…¨å±€çŠ¶æ€ ======
const ROOM = 'bangkok'; // å›ºå®š
let app=null, db=null, ref=null, auth=null;
let CAN_WRITE=false, cloudOn=false;
let locked=true, isPaused=false, applying=false;
let pages=[], currentPage=0, cycleTimer=null;
const STORE_KEY='exchange-cloud-v1-data-store';
const S = (n)=> (+n).toFixed(2);
const sanitize=(s)=>{ const n=parseFloat(String(s).replace(/[^0-9.\-]/g,'')); return isNaN(n)?null:Math.max(0,n); };

// ====== æ•°æ®ï¼ˆæ±‡ç‡ï¼‰ ======
let DATA = [
  {flag:'ğŸ‡ºğŸ‡¸',cn:'ç¾å…ƒ',th:'à¸”à¸­à¸¥à¸¥à¸²à¸£à¹Œà¸ªà¸«à¸£à¸±à¸',en:'USD',country:'United States',items:[
    {denom:'$1',buy:32.10,sell:32.60},{denom:'$5â€“20',buy:32.40,sell:32.70},{denom:'$100',buy:32.70,sell:32.73}]},
  {flag:'ğŸ‡ªğŸ‡º',cn:'æ¬§å…ƒ',th:'à¸¢à¸¹à¹‚à¸£',en:'EUR',country:'European Union',items:[
    {denom:'â‚¬5â€“20',buy:37.60,sell:37.95},{denom:'â‚¬50',buy:37.80,sell:38.00},{denom:'â‚¬100',buy:37.91,sell:38.05}]},
  {flag:'ğŸ‡¬ğŸ‡§',cn:'è‹±é•‘',th:'à¸›à¸­à¸™à¸”à¹Œà¸­à¸±à¸‡à¸à¸¤à¸©',en:'GBP',country:'United Kingdom',items:[
    {denom:'Â£5â€“20',buy:43.10,sell:43.50},{denom:'Â£50',buy:43.40,sell:43.60},{denom:'Â£100',buy:43.51,sell:43.65}]},
  {flag:'ğŸ‡¨ğŸ‡³',cn:'äººæ°‘å¸',th:'à¸«à¸¢à¸§à¸™à¸ˆà¸µà¸™',en:'CNY',country:'China',items:[
    {denom:'Â¥10â€“50',buy:4.55,sell:4.62},{denom:'Â¥100',buy:4.61,sell:4.65},{denom:'Â¥200+',buy:4.62,sell:4.66}]},
  {flag:'ğŸ‡¸ğŸ‡¬',cn:'æ–°å…ƒ',th:'à¸”à¸­à¸¥à¸¥à¸²à¸£à¹Œà¸ªà¸´à¸‡à¸„à¹‚à¸›à¸£à¹Œ',en:'SGD',country:'Singapore',items:[
    {denom:'$20â€“5',buy:27.00,sell:27.30},{denom:'$50â€“100',buy:27.30,sell:27.55},{denom:'$1000',buy:27.25,sell:27.40}]},
  {flag:'ğŸ‡¦ğŸ‡º',cn:'æ¾³å…ƒ',th:'à¸”à¸­à¸¥à¸¥à¸²à¸£à¹Œà¸­à¸­à¸ªà¹€à¸•à¸£à¹€à¸¥à¸µà¸¢',en:'AUD',country:'Australia',items:[
    {denom:'$5â€“20',buy:20.90,sell:21.20},{denom:'$50â€“100',buy:21.13,sell:21.30},{denom:'$500+',buy:21.20,sell:21.35}]},
  {flag:'ğŸ‡­ğŸ‡°',cn:'æ¸¯å¸',th:'à¸”à¸­à¸¥à¸¥à¸²à¸£à¹Œà¸®à¹ˆà¸­à¸‡à¸à¸‡',en:'HKD',country:'Hong Kong',items:[
    {denom:'$20â€“50',buy:4.18,sell:4.21},{denom:'$100â€“500',buy:4.21,sell:4.22},{denom:'$1000',buy:4.215,sell:4.225}]},
  {flag:'ğŸ‡²ğŸ‡¾',cn:'é©¬å¸',th:'à¸£à¸´à¸‡à¸à¸´à¸•à¸¡à¸²à¹€à¸¥à¹€à¸‹à¸µà¸¢',en:'MYR',country:'Malaysia',items:[
    {denom:'5â€“20',buy:7.60,sell:7.72},{denom:'50â€“100',buy:7.68,sell:7.76},{denom:'500+',buy:7.70,sell:7.78}]},
  {flag:'ğŸ‡°ğŸ‡·',cn:'éŸ©å…ƒ',th:'à¸§à¸­à¸™à¹€à¸à¸²à¸«à¸¥à¸µ',en:'KRW',country:'South Korea',items:[
    {denom:'â‚©1kâ€“5k',buy:0.0235,sell:0.0245},{denom:'â‚©10k',buy:0.024,sell:0.025},{denom:'â‚©50k',buy:0.0242,sell:0.0252}]}
];

// ====== å•†å®¶ä¿¡æ¯ï¼ˆé»˜è®¤ï¼‰ ======
let SHOP = {
  on:false, pos:'rb', size:'medium',
  nameCN:'æ™ºèƒ½äº¤æ˜“æ‰€ Â· æ›¼è°·', nameEN:'Intelligent Exchange Â· Bangkok',
  addr:'', phone:'', note:'',
  wechatId:'', lineId:'',
  wechatQR:'', lineQR:''
};

// ====== æ¸²æŸ“è¡¨æ ¼ ======
const pageEl = document.getElementById('page'); const pi = document.getElementById('pageIndicator');
function buildRows(){ const list=[]; DATA.forEach((g,gi)=>g.items.forEach((it,si)=>list.push({gi,si,showHead:si===0}))); return list; }
function setupEditable(scopeEl){
  scopeEl.querySelectorAll('[contenteditable]').forEach(el=>{
    el.addEventListener('blur',()=>{
      if(!CAN_WRITE) return;
      const row = el.closest('.row'); const gi=+row.dataset.gi; const si=+row.dataset.si;
      const k = el.dataset.key;
      if(k==='buy'||k==='sell'){
        const v = sanitize(el.textContent); if(v==null) return;
        DATA[gi].items[si][k] = v; el.textContent = S(v); touch();
      }else if(k==='denom'){
        DATA[gi].items[si].denom = (el.textContent||'').trim()||'â€”'; touch();
      }else{
        DATA[gi][k] = (el.textContent||'').trim(); touch(); render();
      }
    });
  });
}
function drawPage(p){
  const rows = pages[p];
  pageEl.innerHTML='';
  let last=-1;
  rows.forEach((r, idx)=>{
    const g=DATA[r.gi], it=g.items[r.si];
    if(r.gi!==last){
      const head=document.createElement('div'); head.className='row'; head.dataset.gi=r.gi; head.dataset.si=-1;
      head.innerHTML=`
        <div class="cell"><span>${g.flag}</span></div>
        <div class="cell"><b ${!locked?'contenteditable':''} data-key="cn">${g.cn}</b> <span style="opacity:.9">${g.en}</span></div>
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>`;
      setupEditable(head); pageEl.appendChild(head); last=r.gi;
    }
    const row=document.createElement('div'); row.className='row'; row.dataset.gi=r.gi; row.dataset.si=r.si;
    row.innerHTML=`
      <div class="cell"></div>
      <div class="cell"></div>
      <div class="cell"><div class="num denom" ${!locked?'contenteditable':''} data-key="denom">${it.denom}</div></div>
      <div class="cell"><div class="num buy" ${!locked?'contenteditable':''} data-key="buy">${S(it.buy)}</div></div>
      <div class="cell"><div class="num sell" ${!locked?'contenteditable':''} data-key="sell">${S(it.sell)}</div></div>`;
    setupEditable(row); pageEl.appendChild(row);
  });
}
function render(){
  const list=buildRows(); const RPP=(Number(document.getElementById('rppNum').value)||3)*3;
  pages=[]; for(let i=0;i<list.length;i+=RPP) pages.push(list.slice(i,i+RPP));
  if(pages.length===0) pages=[[]];
  currentPage=Math.min(currentPage,pages.length-1);
  drawPage(currentPage);
  pi.textContent = `ç¬¬ ${currentPage+1} / ${pages.length} é¡µ`;
  updateCycle();
}

// ====== è½®æ’­ ======
function updateCycle(){
  if(cycleTimer) clearInterval(cycleTimer); cycleTimer=null;
  const sec = Number(document.getElementById('speed').value)||6;
  const canPlay = !isPaused && sec>0 && pages.length>1;
  document.getElementById('btn-cycle').textContent = canPlay ? 'â¸ï¸ è½®æ’­æš‚åœ' : 'â–¶ï¸ è½®æ’­æ’­æ”¾';
  if(canPlay){ cycleTimer = setInterval(()=>{ currentPage=(currentPage+1)%pages.length; drawPage(currentPage); pi.textContent=`ç¬¬ ${currentPage+1} / ${pages.length} é¡µ`; }, sec*1000); }
}

// ====== æ§ä»¶ç»‘å®š ======
document.getElementById('rppNum').addEventListener('change',render);
document.getElementById('speed').addEventListener('input',e=>{ document.getElementById('speedNum').value=e.target.value; updateCycle(); });
document.getElementById('speedNum').addEventListener('change',e=>{ document.getElementById('speed').value=e.target.value; updateCycle(); });
document.getElementById('btn-cycle').onclick=()=>{ isPaused=!isPaused; updateCycle(); };
document.getElementById('btn-lock').onclick=()=>{ locked=!locked; document.getElementById('btn-lock').textContent=locked?'ğŸ”’ å·²é”å®š':'ğŸ”“ ç¼–è¾‘ä¸­'; render(); };

// ====== æœ¬åœ° & äº‘åŒæ­¥ ======
function touch(){ localStorage.setItem(STORE_KEY, JSON.stringify({data:DATA, shop:SHOP})); document.getElementById('updated').textContent=new Date().toLocaleString(); pushNow(); }

function cloudEnable(on){
  if(on===cloudOn) return;
  if(on){
    try{
      app = firebase.apps?.length ? firebase.app() : firebase.initializeApp(FB_CONFIG);
      db = firebase.database();
      ref = db.ref('exchange/cloud/v1/'+ROOM);
      ref.on('value', snap=>{
        const v=snap.val(); if(!v) return;
        applying=true;
        if(v.data) DATA=v.data;
        if(v.shop) SHOP=v.shop;
        document.getElementById('updated').textContent = new Date(v.updated||Date.now()).toLocaleString();
        render(); renderShop();
        applying=false;
      });
      cloudOn=true; document.getElementById('cloudState').textContent='â˜ï¸ äº‘åŒæ­¥ï¼šå¼€'; pushNow();
    }catch(e){ console.error(e); alert('è¿æ¥ Firebase å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®'); }
  }else{
    if(ref) ref.off();
    cloudOn=false; document.getElementById('cloudState').textContent='â˜ï¸ äº‘åŒæ­¥ï¼šå…³';
  }
}
function pushNow(){ if(!cloudOn || !ref || !CAN_WRITE) return; ref.set({ data: DATA, shop: SHOP, updated: Date.now() }); }

// ====== ç™»å½•ï¼ˆç¦ç”¨è‡ªåŠ¨å¡«å……ï¼‰ ======
const loginFloat=document.getElementById('loginFloat');
const loginDlg=document.getElementById('loginDlg');
document.getElementById('btnCancel').onclick=()=> loginDlg.style.display='none';
loginFloat.onclick=()=> loginDlg.style.display='flex';
document.getElementById('btn-logout').onclick=async()=>{ try{ await firebase.auth().signOut(); alert('å·²é€€å‡º'); location.reload(); }catch(e){} };
document.getElementById('loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  try{
    const acc = (document.getElementById('acc').value||'').trim() || 'znjys';
    const pwd = document.getElementById('pwd').value;
    const email = acc+'@znjys.local';
    if(!auth) auth = firebase.auth();
    const r = await auth.signInWithEmailAndPassword(email, pwd);
    const uid = r.user.uid;
    const s = await firebase.database().ref('roles/'+uid+'/write').once('value');
    CAN_WRITE = (s.val()===true);
    if(!CAN_WRITE){ alert('ç™»å½•æˆåŠŸï¼Œä½†æ²¡æœ‰å†™å…¥æƒé™'); }
    afterLogin(r.user);
    loginDlg.style.display='none';
  }catch(err){ alert('ç™»å½•å¤±è´¥ï¼š'+(err?.message||'')); }
});

function afterLogin(u){
  document.getElementById('loginState').textContent = u?.email||'';
  document.getElementById('controls').style.display='flex';
  loginFloat.style.display='none';
  render(); renderShop();
}

// åˆå§‹åŒ–è®¤è¯ç›‘å¬ï¼ˆç”¨äºåˆ·æ–° UIï¼‰
function initAuth(){
  auth = firebase.auth();
  auth.onAuthStateChanged(u=>{
    if(u){
      document.getElementById('loginState').textContent = u.email||'';
      document.getElementById('controls').style.display='flex';
      loginFloat.style.display='none';
      // æ£€æŸ¥å†™æƒé™
      firebase.database().ref('roles/'+u.uid+'/write').once('value').then(s=>{ CAN_WRITE = (s.val()===true); });
    }else{
      CAN_WRITE=false; locked=true;
      document.getElementById('controls').style.display='none';
      if (new URLSearchParams(location.search).get('admin') === '1') loginFloat.style.display='flex';
      render(); renderShop();
    }
  });
}

// ====== å•†å®¶ä¿¡æ¯ï¼šæ˜¾ç¤ºä¸ç¼–è¾‘ ======
const shopCard = document.getElementById('shopCard');
function renderShop(){
  shopCard.style.display = SHOP.on ? 'block' : 'none';
  shopCard.classList.remove('small','medium','large','pos-lt','pos-rt','pos-lb','pos-rb');
  shopCard.classList.add(SHOP.size||'medium', 'pos-'+(SHOP.pos||'rb'));
  document.getElementById('sc-name').textContent = (SHOP.nameCN||'') + (SHOP.nameEN?(' Â· '+SHOP.nameEN):'');
  document.getElementById('sc-addr').textContent = SHOP.addr||'';
  document.getElementById('sc-phone').textContent = SHOP.phone||'';
  document.getElementById('sc-note').textContent = SHOP.note||'';
  if(SHOP.wechatQR){ document.getElementById('fig-wechat').style.display='block'; document.getElementById('sc-wechat').src=SHOP.wechatQR; }
  else { document.getElementById('fig-wechat').style.display='none'; }
  if(SHOP.lineQR){ document.getElementById('fig-line').style.display='block'; document.getElementById('sc-line').src=SHOP.lineQR; }
  else { document.getElementById('fig-line').style.display='none'; }
  document.getElementById('btn-shop-toggle').textContent = 'å•†å®¶ä¿¡æ¯ï¼š' + (SHOP.on?'å¼€':'å…³');
}

// æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
const shopDlg = document.getElementById('shopDlg');
document.getElementById('btn-shop-edit').onclick=()=>{
  if(!CAN_WRITE){ alert('æœªç™»å½•æˆ–æ— å†™å…¥æƒé™'); return; }
  // å¡«å……è¡¨å•
  document.getElementById('f_on').value = SHOP.on?'true':'false';
  document.getElementById('f_pos').value = SHOP.pos||'rb';
  document.getElementById('f_size').value = SHOP.size||'medium';
  document.getElementById('f_name_cn').value = SHOP.nameCN||'';
  document.getElementById('f_name_en').value = SHOP.nameEN||'';
  document.getElementById('f_addr').value = SHOP.addr||'';
  document.getElementById('f_phone').value = SHOP.phone||'';
  document.getElementById('f_note').value = SHOP.note||'';
  document.getElementById('f_wechat_id').value = SHOP.wechatId||'';
  document.getElementById('f_line_id').value = SHOP.lineId||'';
  shopDlg.style.display='flex';
};
document.getElementById('btnShopCancel').onclick=()=> shopDlg.style.display='none';
document.getElementById('btnShopSave').onclick=async()=>{
  if(!CAN_WRITE){ alert('æœªç™»å½•æˆ–æ— å†™å…¥æƒé™'); return; }
  SHOP.on = document.getElementById('f_on').value==='true';
  SHOP.pos = document.getElementById('f_pos').value;
  SHOP.size = document.getElementById('f_size').value;
  SHOP.nameCN = document.getElementById('f_name_cn').value.trim();
  SHOP.nameEN = document.getElementById('f_name_en').value.trim();
  SHOP.addr = document.getElementById('f_addr').value.trim();
  SHOP.phone = document.getElementById('f_phone').value.trim();
  SHOP.note = document.getElementById('f_note').value.trim();
  SHOP.wechatId = document.getElementById('f_wechat_id').value.trim();
  SHOP.lineId = document.getElementById('f_line_id').value.trim();

  // è¯»å–äºŒç»´ç æ–‡ä»¶ä¸º dataURL
  const fWe = document.getElementById('f_wechat_qr').files[0];
  const fLi = document.getElementById('f_line_qr').files[0];
  const readAsDataURL = (file)=> new Promise((resolve)=>{ if(!file) return resolve(null); const r=new FileReader(); r.onload=()=>resolve(r.result); r.readAsDataURL(file); });
  const [we,li] = await Promise.all([readAsDataURL(fWe), readAsDataURL(fLi)]);
  if(we) SHOP.wechatQR = we;
  if(li) SHOP.lineQR = li;

  touch(); renderShop();
  alert('å·²ä¿å­˜');
  shopDlg.style.display='none';
};

document.getElementById('btn-shop-toggle').onclick=()=>{
  if(!CAN_WRITE){ alert('æœªç™»å½•æˆ–æ— å†™å…¥æƒé™'); return; }
  SHOP.on = !SHOP.on; renderShop(); touch();
};

// ====== åˆå§‹åŒ– ======
(function init(){
  // æœ¬åœ°ç¼“å­˜
  const saved = localStorage.getItem(STORE_KEY);
  if(saved){ try{ const x=JSON.parse(saved); if(x.data) DATA=x.data; if(x.shop) SHOP=x.shop; }catch(e){} }
  // UI
  render(); renderShop();
  // äº‘åŒæ­¥é»˜è®¤å¼€å¯
  cloudEnable(true);
  // è®¤è¯ç›‘å¬
  initAuth();
  // æ—¶é’Ÿ
  (function tick(){ const n=new Date(); document.getElementById('time').textContent=n.toLocaleTimeString(); document.getElementById('date').textContent=n.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric',weekday:'long'}); setTimeout(tick,1000); })();
  // é”®ç›˜
  document.addEventListener('keydown',e=>{
    if(e.key===' '){ e.preventDefault(); isPaused=!isPaused; updateCycle(); }
    if(e.key==='F'||e.key==='f'){ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
    if(e.key==='ArrowRight'){ currentPage=(currentPage+1)%pages.length; drawPage(currentPage); pi.textContent=`ç¬¬ ${currentPage+1} / ${pages.length} é¡µ`; }
    if(e.key==='ArrowLeft'){ currentPage=(currentPage-1+pages.length)%pages.length; drawPage(currentPage); pi.textContent=`ç¬¬ ${currentPage+1} / ${pages.length} é¡µ`; }
  });
})();
</script>
</body>
</html>
