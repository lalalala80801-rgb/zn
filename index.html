<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
<title>智能交易所 · 曼谷 · 云同步（终极版 v3.0）</title>
<style>
:root{
  --bg:#0a0f1a; --pane:#0f172a; --pane2:#0b1324; --grid:#233146;
  --text:#e5e7eb; --muted:#9fb3c8; --buy:#ef4444; --sell:#3b82f6;
  --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:radial-gradient(1200px 800px at 10% -10%,#0b1b30 10%,#0a0f1a 60%);
  color:var(--text);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei","Segoe UI Emoji","Noto Color Emoji","Apple Color Emoji",sans-serif;
  -webkit-font-smoothing:antialiased;
}
.wrap{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
/* ===== 顶部面板 ===== */
header{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;padding:10px 12px}
#brand{font-weight:900;font-size:20px}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;transition:.2s}
.btn{background:#111827;border:1px solid #2b3648;border-radius:10px;color:#e5e7eb;padding:6px 10px;font-weight:600;cursor:pointer}
.btn:disabled{opacity:.5;cursor:not-allowed}
.inline{display:inline-flex;align-items:center;gap:6px}
.small{font-size:12px;opacity:.85}
.clock{text-align:right}.clock .time{font-size:22px;font-weight:800}.clock .date{font-size:12px;opacity:.9}
#togglePanel{position:relative}
#togglePanel[aria-pressed="true"]{background:#0c1a32}
/* ===== 表格区域 ===== */
.board{background:linear-gradient(180deg,#0f172a,#0b1324);border:1px solid var(--grid);border-radius:var(--radius);overflow:hidden;margin:10px 12px;box-shadow:0 12px 32px rgba(0,0,0,.35)}
.thead,.row{display:grid;grid-template-columns:88px 1fr 220px 190px 190px;align-items:center}
.thead{background:#0e1527;border-bottom:1px solid var(--grid);position:sticky;top:0;z-index:2}
.cell{padding:10px 8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:22px}
.tb{max-height:72vh;overflow:hidden;position:relative}
.num{min-width:8ch;text-align:center;padding:6px 8px;border-radius:8px}
.buy{color:var(--buy);font-weight:900}.sell{color:var(--sell);font-weight:900}.denom{font-weight:900;min-width:7ch;text-align:center}
/* 页码气泡：不挡交互 */
.page-indicator{position:absolute;left:50%;bottom:8px;transform:translateX(-50%);
  background:rgba(0,0,0,.28);border:1px solid #223049;border-radius:999px;padding:4px 8px;
  font-weight:800;font-size:12px;pointer-events:none}
/* 底部 */
footer{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;padding:10px 12px;border-top:1px solid var(--grid);color:var(--muted)}
/* 登录悬浮按钮：默认隐藏，?admin=1 显示 */
#loginFloat{position:fixed;right:16px;bottom:22px;z-index:1000;background:#0b1222d9;border:1px solid #2b3648;color:#e5e7eb;border-radius:999px;height:44px;padding:0 14px;display:none;gap:8px;justify-content:center;align-items:center;font-weight:700;box-shadow:0 8px 20px rgba(0,0,0,.35)}
/* 登录弹窗 */
#loginDlg{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1200}
#loginPanel{background:#0b1222;border:1px solid #2b3648;border-radius:14px;width:min(420px,92vw);padding:16px}
#loginPanel h3{margin:0 0 10px 0}
.form-row{display:flex;gap:8px;align-items:center;margin:8px 0}
.form-row label{width:80px;color:#9fb3c8}
.form-row input{flex:1;background:#0b1222;color:#e5e7eb;border:1px solid #2b3648;border-radius:8px;padding:10px}
.form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
/* ===== 响应式：手机竖屏 ===== */
@media (max-width: 480px){
  .thead,.row{grid-template-columns:56px 1fr 120px 100px 100px}
  .cell{font-size:18px}
  #brand{font-size:16px}
}
</style>
</head>
<body>
<button id="loginFloat">🔐 登录</button>
<div class="wrap">
  <header>
    <div id="brand">智能交易所 · 曼谷</div>
    <div class="controls" id="controls" style="display:none">
      <button class="btn" id="btn-cycle">▶️ 播放</button>
      <label class="btn inline">速度
        <input id="speed" type="range" min="0" max="60" step="1" value="6" style="width:120px">
        <input id="speedNum" type="number" min="0" max="120" step="1" value="6" style="width:54px;background:#0b1222;color:#e5e7eb;border:1px solid #2b3648;border-radius:8px;padding:6px">
        <span>秒</span>
      </label>
      <label class="btn inline">每页国家
        <input id="rppNum" type="number" min="2" max="8" step="1" value="3" style="width:46px;background:#0b1222;color:#e5e7eb;border:1px solid #2b3648;border-radius:8px;padding:6px">
      </label>
      <label class="btn inline"><input id="chkPauseEdit" type="checkbox" checked> 编辑时暂停</label>
      <button class="btn" id="btnFontDown">A-</button>
      <button class="btn" id="btnFontUp">A+</button>
      <button class="btn" id="btnFull">全屏</button>
      <button class="btn" id="btnExport">导出</button>
      <button class="btn" id="btnImport">导入</button>
      <button class="btn" id="btnReset">恢复默认</button>
      <button class="btn" id="btnHide" title="隐藏/显示面板">隐藏设置</button>
      <button class="btn" id="btnLogout">退出</button>
      <span class="small" id="loginState"></span>
      <span class="small" id="cloudState">☁️ 云同步：开</span>
    </div>
    <div class="clock">
      <div class="time" id="time">--:--:--</div>
      <div class="date" id="date">—</div>
    </div>
  </header>

  <section class="board">
    <div class="thead">
      <div class="cell"></div>
      <div class="cell">Currency 货币 · สกุลเงิน</div>
      <div class="cell" style="text-align:center">Denomination 面额</div>
      <div class="cell" style="text-align:center;color:#ef4444;font-weight:900">BUY 买入</div>
      <div class="cell" style="text-align:center;color:#3b82f6;font-weight:900">SELL 卖出</div>
    </div>
    <div class="tb">
      <div id="page"></div>
      <div class="page-indicator" id="pageIndicator">第 1 / 1 页</div>
    </div>
  </section>

  <footer>
    <div>快捷键：F 全屏 · Space 播放/暂停 · ←/→ 换页</div>
    <div>上次修改：<span id="updated">—</span></div>
    <div style="text-align:right">汇率仅供参考，成交以柜台报价为准。</div>
  </footer>
</div>

<!-- 登录弹窗（禁用自动填充） -->
<div id="loginDlg">
  <div id="loginPanel">
    <h3>员工登录</h3>
    <form id="loginForm" autocomplete="off">
      <div class="form-row"><label>账号</label><input id="acc" name="acc_x" type="text" inputmode="latin" autocomplete="off" placeholder="例如 znjys"></div>
      <div class="form-row"><label>密码</label><input id="pwd" name="pwd_x" type="password" autocomplete="new-password" placeholder="例如 5201314"></div>
      <div class="form-actions">
        <button type="button" class="btn" id="btnCancel">取消</button>
        <button type="submit" class="btn">登录</button>
      </div>
    </form>
  </div>
</div>

<!-- Twemoji：让国旗等 Emoji 变为图片，任何设备都能显示 -->
<script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script>
window.FB_CONFIG = {"apiKey": "AIzaSyD0dEK5P8CHdHPUBFCNLQRBlSRuCtv3GIs", "authDomain": "znjys-b4c98.firebaseapp.com", "databaseURL": "https://znjys-b4c98-default-rtdb.asia-southeast1.firebasedatabase.app", "projectId": "znjys-b4c98", "storageBucket": "znjys-b4c98.firebasestorage.app", "messagingSenderId": "762313114991", "appId": "1:762313114991:web:092c17431572a281f0549a", "measurementId": "G-W835L9T6DG"};
const ROOM='bangkok';        // 固定房间
const STORE_KEY='exchange-cloud-v1-data-store';
let app=null, db=null, ref=null, auth=null;
let CAN_WRITE=false, cloudOn=false;
let isPaused=false, pages=[], currentPage=0, cycleTimer=null, applying=false, hidePanel=false;
let baseFont=1;              // 用于字体缩放
let pauseWhenEdit=true;

const S = (n)=> (+n).toFixed(2);
const sanitize=(s)=>{ const n=parseFloat(String(s).replace(/[^0-9.\-]/g,'')); return isNaN(n)?null:Math.max(0,n); };

// ===== 默认数据（每币种三行面额） =====
let DATA=[
  {flag:'🇺🇸', cn:'美元', th:'ดอลลาร์สหรัฐ', en:'USD', country:'United States',items:[
    {denom:'$1',buy:32.10,sell:32.60},{denom:'$5–20',buy:32.40,sell:32.70},{denom:'$100',buy:32.70,sell:32.73}]},
  {flag:'🇪🇺', cn:'欧元', th:'ยูโร', en:'EUR', country:'European Union',items:[
    {denom:'€5–20',buy:37.60,sell:37.95},{denom:'€50',buy:37.80,sell:38.00},{denom:'€100',buy:37.91,sell:38.05}]},
  {flag:'🇬🇧', cn:'英镑', th:'ปอนด์อังกฤษ', en:'GBP', country:'United Kingdom',items:[
    {denom:'£5–20',buy:43.10,sell:43.50},{denom:'£50',buy:43.40,sell:43.60},{denom:'£100',buy:43.51,sell:43.65}]},
  {flag:'🇨🇳', cn:'人民币', th:'หยวนจีน', en:'CNY', country:'China',items:[
    {denom:'¥10–50',buy:4.55,sell:4.62},{denom:'¥100',buy:4.61,sell:4.65},{denom:'¥200+',buy:4.62,sell:4.66}]},
  {flag:'🇸🇬', cn:'新元', th:'ดอลลาร์สิงคโปร์', en:'SGD', country:'Singapore',items:[
    {denom:'$20–5',buy:27.00,sell:27.30},{denom:'$50–100',buy:27.30,sell:27.55},{denom:'$1000',buy:27.25,sell:27.40}]},
  {flag:'🇦🇺', cn:'澳元', th:'ดอลลาร์ออสเตรเลีย', en:'AUD', country:'Australia',items:[
    {denom:'$5–20',buy:20.90,sell:21.20},{denom:'$50–100',buy:21.13,sell:21.30},{denom:'$500+',buy:21.20,sell:21.35}]},
  {flag:'🇭🇰', cn:'港币', th:'ดอลลาร์ฮ่องกง', en:'HKD', country:'Hong Kong',items:[
    {denom:'$20–50',buy:4.18,sell:4.21},{denom:'$100–500',buy:4.21,sell:4.22},{denom:'$1000',buy:4.215,sell:4.225}]},
  {flag:'🇲🇾', cn:'马币', th:'ริงกิตมาเลเซีย', en:'MYR', country:'Malaysia',items:[
    {denom:'5–20',buy:7.60,sell:7.72},{denom:'50–100',buy:7.68,sell:7.76},{denom:'500+',buy:7.70,sell:7.78}]},
  {flag:'🇰🇷', cn:'韩元', th:'วอนเกาหลี', en:'KRW', country:'South Korea',items:[
    {denom:'₩1k–5k',buy:0.0235,sell:0.0245},{denom:'₩10k',buy:0.024,sell:0.025},{denom:'₩50k',buy:0.0242,sell:0.0252}]}
];

// ====== 渲染 ======
const pageEl=document.getElementById('page'); const pi=document.getElementById('pageIndicator');
function buildRows(){ const rows=[]; DATA.forEach((g,gi)=>g.items.forEach((it,si)=>rows.push({gi,si,showHead:si===0}))); return rows; }
function setupEditable(scopeEl){
  scopeEl.querySelectorAll('[contenteditable]').forEach(el=>{
    el.addEventListener('focus',()=>{ if(pauseWhenEdit){ isPaused=true; updateCycle(); }});
    el.addEventListener('blur',()=>{
      const r=el.closest('.row'); const gi=+r.dataset.gi, si=+r.dataset.si, k=el.dataset.key;
      if(!CAN_WRITE){ return; }
      if(k==='buy'||k==='sell'){ const v=sanitize(el.textContent); if(v==null) return; DATA[gi].items[si][k]=v; el.textContent=S(v); }
      else if(k==='denom'){ DATA[gi].items[si].denom=(el.textContent||'').trim()||'—'; }
      else if(k==='cn'){ DATA[gi].cn=(el.textContent||'').trim(); }
      pushNow();
      localStorage.setItem(STORE_KEY, JSON.stringify({data:DATA}));
      document.getElementById('updated').textContent=new Date().toLocaleString();
    });
  });
}
function drawPage(p){
  const rows=pages[p]; pageEl.innerHTML=''; let last=-1;
  rows.forEach((r)=>{
    const g=DATA[r.gi], it=g.items[r.si];
    if(r.gi!==last){
      const head=document.createElement('div'); head.className='row'; head.dataset.gi=r.gi; head.dataset.si=-1;
      head.innerHTML=`
        <div class="cell flag">${g.flag}</div>
        <div class="cell"><b ${CAN_WRITE?'contenteditable':''} data-key="cn">${g.cn}</b> <span style="opacity:.9">${g.en}</span></div>
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>`;
      pageEl.appendChild(head); setupEditable(head); last=r.gi;
    }
    const row=document.createElement('div'); row.className='row'; row.dataset.gi=r.gi; row.dataset.si=r.si;
    row.innerHTML=`
      <div class="cell"></div><div class="cell"></div>
      <div class="cell"><div class="num denom" ${CAN_WRITE?'contenteditable':''} data-key="denom">${it.denom}</div></div>
      <div class="cell"><div class="num buy" ${CAN_WRITE?'contenteditable':''} data-key="buy">${S(it.buy)}</div></div>
      <div class="cell"><div class="num sell" ${CAN_WRITE?'contenteditable':''} data-key="sell">${S(it.sell)}</div></div>`;
    pageEl.appendChild(row); setupEditable(row);
  });
  // Twemoji 转换（确保旗帜显示）
  if(window.twemoji) twemoji.parse(pageEl,{folder:'svg',ext:'.svg'});
}
function paginate(){
  const rpp=(Number(document.getElementById('rppNum').value)||3)*3;
  const rows=buildRows(); pages=[]; for(let i=0;i<rows.length;i+=rpp) pages.push(rows.slice(i,i+rpp));
  if(pages.length===0) pages=[[]];
  currentPage=Math.min(currentPage,pages.length-1);
  drawPage(currentPage);
  pi.textContent=`第 ${currentPage+1} / ${pages.length} 页`;
  updateCycle();
}

// ====== 轮播 ======
function updateCycle(){
  if(cycleTimer) clearInterval(cycleTimer); cycleTimer=null;
  const sec=Number(document.getElementById('speed').value)||6;
  const play = !isPaused && sec>0 && pages.length>1;
  document.getElementById('btn-cycle').textContent = play?'⏸️ 暂停':'▶️ 播放';
  if(play){
    cycleTimer=setInterval(()=>{
      currentPage=(currentPage+1)%pages.length; drawPage(currentPage);
      pi.textContent=`第 ${currentPage+1} / ${pages.length} 页`;
    }, sec*1000);
  }
}

// ====== 控件绑定 ======
document.getElementById('btn-cycle').onclick=()=>{ isPaused=!isPaused; updateCycle(); };
document.getElementById('speed').addEventListener('input',e=>{ document.getElementById('speedNum').value=e.target.value; updateCycle(); });
document.getElementById('speedNum').addEventListener('change',e=>{ document.getElementById('speed').value=e.target.value; updateCycle(); });
document.getElementById('rppNum').addEventListener('change',paginate);
document.getElementById('chkPauseEdit').addEventListener('change',e=>{ pauseWhenEdit=e.target.checked; });
document.getElementById('btnFontUp').onclick=()=>{ baseFont=Math.min(1.6, baseFont+0.05); document.documentElement.style.setProperty('--fs-base', baseFont); };
document.getElementById('btnFontDown').onclick=()=>{ baseFont=Math.max(0.7, baseFont-0.05); document.documentElement.style.setProperty('--fs-base', baseFont); };
document.getElementById('btnFull').onclick=()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); };
document.getElementById('btnHide').onclick=()=>{
  hidePanel=!hidePanel;
  document.getElementById('controls').style.display = hidePanel?'none':'flex';
};
document.getElementById('btnExport').onclick=()=>{
  const blob=new Blob([JSON.stringify({data:DATA},null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='exchange_backup.json'; a.click(); URL.revokeObjectURL(a.href);
};
document.getElementById('btnImport').onclick=()=>{
  const i=document.createElement('input'); i.type='file'; i.accept='application/json'; i.onchange=()=>{
    const f=i.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(obj?.data){ DATA=obj.data; paginate(); pushNow(); } }catch(e){ alert('导入失败'); } }; r.readAsText(f);
  }; i.click();
};
document.getElementById('btnReset').onclick=()=>{ if(confirm('恢复默认数据？')){ localStorage.removeItem(STORE_KEY); location.reload(); }};
document.getElementById('btnLogout').onclick=async()=>{ try{ await firebase.auth().signOut(); alert('已退出'); location.reload(); }catch(e){} };

// ====== 云同步 ======
function pushNow(){ if(!cloudOn||!ref||!CAN_WRITE||applying) return; ref.set({ data:DATA, updated:Date.now() }); }
function cloudEnable(on){
  if(on===cloudOn) return;
  if(on){
    try{
      app=firebase.apps?.length?firebase.app():firebase.initializeApp(FB_CONFIG);
      db=firebase.database(); auth=firebase.auth();
      ref=db.ref('exchange/cloud/v1/'+ROOM);
      ref.on('value',snap=>{
        const v=snap.val(); if(!v) return;
        applying=true;
        if(v.data) DATA=v.data;
        document.getElementById('updated').textContent=new Date(v.updated||Date.now()).toLocaleString();
        paginate(); applying=false;
      });
      cloudOn=true; document.getElementById('cloudState').textContent='☁️ 云同步：开';
    }catch(e){ console.error(e); alert('连接 Firebase 失败，请检查配置'); }
  }else{
    if(ref) ref.off(); cloudOn=false; document.getElementById('cloudState').textContent='☁️ 云同步：关';
  }
}

// ====== 登录（仅 ?admin=1 显示入口；禁用自动填充） ======
const loginFloat=document.getElementById('loginFloat'); const loginDlg=document.getElementById('loginDlg');
if (new URLSearchParams(location.search).get('admin')==='1') loginFloat.style.display='flex';
loginFloat.onclick=()=> loginDlg.style.display='flex';
document.getElementById('btnCancel').onclick=()=> loginDlg.style.display='none';
document.getElementById('loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  try{
    const acc=(document.getElementById('acc').value||'').trim()||'znjys';
    const pwd=document.getElementById('pwd').value;
    const email=acc+'@znjys.local';
    const r=await firebase.auth().signInWithEmailAndPassword(email,pwd);
    const uid=r.user.uid;
    const s=await firebase.database().ref('roles/'+uid+'/write').once('value');
    CAN_WRITE=(s.val()===true);
    if(!CAN_WRITE) alert('登录成功，但缺少写权限');
    document.getElementById('controls').style.display='flex';
    document.getElementById('loginState').textContent=email;
    loginFloat.style.display='none'; loginDlg.style.display='none';
    paginate(); // 刷新可编辑状态
  }catch(err){ alert('登录失败：'+(err?.message||'')); }
});

// ====== 初始化 ======
(function init(){
  // 本地缓存优先
  try{ const saved=JSON.parse(localStorage.getItem(STORE_KEY)||'null'); if(saved?.data) DATA=saved.data; }catch{}
  // 时钟
  (function tick(){ const n=new Date(); document.getElementById('time').textContent=n.toLocaleTimeString(); document.getElementById('date').textContent=n.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric',weekday:'long'}); setTimeout(tick,1000); })();
  // 启动渲染与云同步
  paginate(); cloudEnable(true);
  // 快捷键
  document.addEventListener('keydown',e=>{
    if(e.key===' '){ e.preventDefault(); isPaused=!isPaused; updateCycle(); }
    if(e.key==='F'||e.key==='f'){ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
    if(e.key==='ArrowRight'){ currentPage=(currentPage+1)%pages.length; drawPage(currentPage); pi.textContent=`第 ${currentPage+1} / ${pages.length} 页`; }
    if(e.key==='ArrowLeft'){ currentPage=(currentPage-1+pages.length)%pages.length; drawPage(currentPage); pi.textContent=`第 ${currentPage+1} / ${pages.length} 页`; }
  });
  // 初次 twemoji
  if(window.twemoji) twemoji.parse(document.body,{folder:'svg',ext:'.svg'});
})();
</script>
</body>
</html>
